/*
 * Webim v1.0.0pre
 * http://www.nextim.cn/
 *
 * Copyright (c) 2009 Hidden
 *
 * Date: 
 * Revision: 
 */
(function(J,d,m){function K(){return(new Date).getTime()}var z=Object.prototype.toString;function r(S){return z.call(S)==="[object Function]"}function c(){var T=t("tid");if(T==""){var S=new RegExp("/thread-([^-])-","i");if(S.test(location.href)){T=RegExp.$1}}return T}function t(T){var S=new RegExp("(^|\\?|&)"+T+"=([^&]*)(\\s|&|$)","i");if(S.test(location.href)){return unescape(RegExp.$2.replace(/\+/g," "))}return""}function w(S){return z.call(S)==="[object Array]"}function F(S){return S&&z.call(S)==="[object Object]"}function a(S){return(S||"").replace(/^\s+|\s+$/g,"")}function R(S,V){var U=false;if(F(V)){S=S||{};for(var T in V){var W=V[T];if(S[T]!=W){U=U||{};U[T]=W}}}return U}function q(U){var S=[];if(U!=null){var T=U.length;if(T==null||typeof U==="string"||r(U)||U.setInterval){S[0]=U}else{while(T){S[--T]=U[T]}}}return S}function k(){var X=arguments[0]||{},V=1,W=arguments.length,S=false,U;if(typeof X==="boolean"){S=X;X=arguments[1]||{};V=2}if(typeof X!=="object"&&!r(X)){X={}}for(;V<W;V++){if((U=arguments[V])!=null){for(var T in U){var Y=X[T],Z=U[T];if(X===Z){continue}if(S&&Z&&typeof Z==="object"&&!Z.nodeType){X[T]=k(S,Y||(Z.length!=null?[]:{}),Z)}else{if(Z!==m){X[T]=Z}}}}}return X}function L(V,Z,U){var T,W=0,X=V.length,S=X===m||r(V);if(U){if(S){for(T in V){if(Z.apply(V[T],U)===false){break}}}else{for(;W<X;){if(Z.apply(V[W++],U)===false){break}}}}else{if(S){for(T in V){if(Z.call(V[T],T,V[T])===false){break}}}else{for(var Y=V[0];W<X&&Z.call(Y,W,Y)!==false;Y=V[++W]){}}}return V}function M(U,V){for(var S=0,T=V.length;S<T;S++){if(V[S]===U){return S}}return -1}function O(T,X,S){var U=[];for(var V=0,W=T.length;V<W;V++){if(!S!==!X(T[V],V)){U.push(T[V])}}return U}function x(S,X){var T=[],W;for(var U=0,V=S.length;U<V;U++){W=X(S[U],U);if(W!=null){T[T.length]=W}}return T.concat.apply([],T)}var u={option:function(U,V){var T=U,S=this;S.options=S.options||{};if(typeof U=="string"){if(V===m){return S.options[U]}T={};T[U]=V}k(S.options,T);return S},bind:function(U,T){var S=this,V=S._events=S._events||{};if(r(T)){V[U]=V[U]||[];V[U].push(T)}return this},trigger:function(X,U){var T=this,Y=T._events=T._events||{},W=Y[X];if(!W){return this}U=w(U)?U:q(U);for(var V=0,S=W.length;V<S;V++){W[V].apply(this,U)}return this},unbind:function(W,V){var T=this,X=T._events=T._events||{};if(!X[W]){return this}if(r(V)){var S=X[W];for(var U=S.length;U--;U){if(S[U]===V||S[U]===V._proxy){S.splice(U,1)}}}else{delete X[W]}return this},one:function(V,U){if(!r(U)){return this}var S=this,T=U._proxy=fun._proxy||function(){S.unbind(V,T);return U.apply(this,arguments)};S.bind(V,T)}};function h(S){var U=[];if(typeof S=="object"){for(var T in S){U[U.length]=encodeURIComponent(T)+"="+encodeURIComponent(S[T])}return U.join("&").replace(Q,"+")}return S}var f=K(),I=/\?/,G=/(\?|&)_=.*?(&|$)/,Q=/%20/g,j={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return J.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},E={},p={};function N(T,V,S,U){if(T.error){T.error.call(T.context||J,V,S,U)}}function s(T){try{return !T.status&&location.protocol==="file:"||(T.status>=200&&T.status<300)||T.status===304||T.status===1223||T.status===0}catch(S){}return false}function o(V,T){var U=V.getResponseHeader("Last-Modified"),S=V.getResponseHeader("Etag");if(U){E[T]=U}if(S){p[T]=S}return V.status===304||V.status===0}function v(X,V,U){var T=X.getResponseHeader("content-type"),S=V==="xml"||!V&&T&&T.indexOf("xml")>=0,W=S?X.responseXML:X.responseText;if(S&&W.documentElement.nodeName==="parsererror"){throw"parsererror"}if(U&&U.dataFilter){W=U.dataFilter(W,V)}if(typeof W==="string"){if(V==="json"){if(typeof g==="object"&&g.parse){W=g.parse(W)}else{W=(new Function("return "+W))()}}}return W}function H(S){k(j,S)}function B(af){af=k(true,af,k(true,{},j,af));var V,W,U=af.context||J,aa=af.type.toUpperCase();if(af.data&&af.processData&&typeof af.data!=="string"){af.data=h(af.data)}if(af.cache===false&&aa==="GET"){var Z=K();var Y=af.url.replace(G,"$1_="+Z+"$2");af.url=Y+((Y===af.url)?(I.test(af.url)?"&":"?")+"_="+Z:"")}if(af.data&&aa==="GET"){af.url+=(I.test(af.url)?"&":"?")+af.data}var T=false;var ae=af.xhr();if(af.username){ae.open(aa,af.url,af.async,af.username,af.password)}else{ae.open(aa,af.url,af.async)}try{if(af.data){ae.setRequestHeader("Content-Type",af.contentType)}if(af.ifModified){if(E[af.url]){ae.setRequestHeader("If-Modified-Since",E[af.url])}if(p[af.url]){ae.setRequestHeader("If-None-Match",p[af.url])}}ae.setRequestHeader("X-Requested-With","XMLHttpRequest");ae.setRequestHeader("Accept",af.dataType&&af.accepts[af.dataType]?af.accepts[af.dataType]+", */*":af.accepts._default)}catch(X){}if(af.beforeSend&&af.beforeSend.call(U,ae,af)===false){ae.abort();return false}var ac=function(ag){if(!ae||ae.readyState===0){if(ab){clearInterval(ab);ab=null}}else{if(!T&&ae&&(ae.readyState===4||ag==="timeout")){T=true;if(ab){clearInterval(ab);ab=null}V=ag==="timeout"?"timeout":!s(ae)?"error":af.ifModified&&o(ae,af.url)?"notmodified":"success";if(V==="success"){try{W=v(ae,af.dataType,af)}catch(ah){V="parsererror"}}if(V==="success"||V==="notmodified"){ad()}else{N(af,ae,V)}S();if(ag){ae.abort()}if(af.async){ae=null}}}};if(af.async){var ab=setInterval(ac,13);if(af.timeout>0){setTimeout(function(){if(ae&&!T){ac("timeout")}},af.timeout)}}try{ae.send(aa==="POST"||aa==="PUT"?af.data:null)}catch(X){N(af,ae,null,X)}if(!af.async){ac()}function ad(){if(af.success){af.success.call(U,W,V)}}function S(){if(af.complete){af.complete.call(U,ae,V)}}return ae}function A(){}function l(aa){aa=k({},aa);var U=""+h(aa.data),S=aa.context||J,Y="jsonp"+f++,W=d.getElementsByTagName("head")[0]||d.documentElement,X=d.createElement("script");U=(U?(U+"&"):"")+(aa.jsonp||"callback")+"="+Y;aa.url+=(I.test(aa.url)?"&":"?")+U;X.src=aa.url;if(aa.scriptCharset){X.charset=aa.scriptCharset}var T=false;J[Y]=function(ab){aa.success&&aa.success.call(S,ab,"success");Z()};X.onload=X.onreadystatechange=function(){if(!T&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){V("error");Z()}};if(aa.timeout>0){setTimeout(function(){if(!T){V("timeout");Z();J[Y]=A}},aa.timeout)}W.insertBefore(X,W.firstChild);return m;function Z(){T=true;J[Y]=m;try{delete J[Y]}catch(ab){}X.onload=X.onreadystatechange=null;if(W&&X.parentNode){W.removeChild(X)}}function V(ab){aa.error&&aa.error.call(S,ab)}}var g=(function(){var T={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function U(V){return T[V]||"\\u00"+Math.floor(V.charCodeAt()/16).toString(16)+(V.charCodeAt()%16).toString(16)}function S(aa){switch(Object.prototype.toString.call(aa)){case"[object String]":return'"'+aa.replace(/[\x00-\x1f\\"]/g,U)+'"';case"[object Array]":var W=[],V=aa.length;for(var Z=0;Z<V;Z++){W.push(S(aa[Z]))}return"["+W.join(",")+"]";case"[object Object]":var W=[];for(var Y in aa){var X=S(aa[Y]);if(X){W.push(S(Y)+":"+X)}}return"{"+W+"}";case"[object Number]":case"[object Boolean]":return String(aa);case false:return"null"}return null}return{encode:S,decode:function(V){if(!V||!V.length){return null}return(new Function("return "+V))()}}})();function C(U,T){var S=this;S._setting();S.options={jsonp:false,host:null,port:null,server:null,ticket:null,domain:null,url:{send:null}};k(S.options,T)}k(C.prototype,u,{_setting:function(){var S=this;S.connected=false;S._connecting=false;S._onPolling=false;S._pollTimer=null;S._pollingTimes=0;S._failTimes=0},connect:function(U){var S=this;k(S.options,U);if(S._connecting){return S}S._connecting=true;var U=S.options,T=false,V=[];L(["server","ticket","domain"],function(X,W){if(!U[W]){V.push(W);V.push(" required.");T=true}});if(T){S._onError("error",V.join(" "));return S}if(!S._onPolling){J.setTimeout(function(){S._startPolling()},300)}return S},close:function(){var S=this;if(S._pollTimer){clearTimeout(S._pollTimer)}S._setting();return S},_onConnect:function(){var S=this;S.connected=true;S.trigger("connect","success")},_onClose:function(S){var T=this;T._setting();T.trigger("close",[S])},_onData:function(T){var S=this;S.trigger("data",T)},_onError:function(T){var S=this;S._setting();S.trigger("error",T)},_startPolling:function(){var S=this,U=S.options;S._onPolling=true;S._pollingTimes++;var T=U.server+"/packets";var V={domain:U.domain,ticket:U.ticket};var W={url:T,data:V,timeout:40000,cache:false,context:S,success:S._onPollSuccess,error:S._onPollError};if(U.jsonp){k(W,{timeout:40000,dataType:"jsonp",jsonp:"callback"});l(W)}else{B(W)}},_onPollSuccess:function(T){var S=this;S._onPolling=false;if(!S._connecting){return}if(S._pollingTimes==1){S._onConnect()}S._onData(T);S._failTimes=0;S._pollTimer=J.setTimeout(function(){S._startPolling()},200)},_onPollError:function(S){var T=this;T._onPolling=false;if(!T._connecting){return}T._failTimes++;if(T._pollingTimes==1){T._onError("can not connect.")}else{if(T._failTimes>1){T._onClose(S)}else{T._pollTimer=J.setTimeout(function(){T._startPolling()},200)}}}});function y(T,aa,ad){if(typeof aa!="undefined"){ad=ad||{};if(aa===null){aa="";ad=k({},ad);ad.expires=-1}var W="";if(ad.expires&&(typeof ad.expires=="number"||ad.expires.toUTCString)){var X;if(typeof ad.expires=="number"){X=new Date();X.setTime(X.getTime()+(ad.expires*24*60*60*1000))}else{X=ad.expires}W="; expires="+X.toUTCString()}var ac=ad.path?"; path="+(ad.path):"";var Y=ad.domain?"; domain="+(ad.domain):"";var S=ad.secure?"; secure":"";d.cookie=[T,"=",encodeURIComponent(aa),W,ac,Y,S].join("")}else{var V=null;if(d.cookie&&d.cookie!=""){var ab=d.cookie.split(";");for(var Z=0;Z<ab.length;Z++){var U=a(ab[Z]);if(U.substring(0,T.length+1)==(T+"=")){V=decodeURIComponent(U.substring(T.length+1));break}}}return V}}var P=true;function i(X,Y){if(!P){return}var W=new Date(),U=["[",W.getHours(),":",W.getMinutes(),":",W.getSeconds(),"-",W.getMilliseconds(),"]"].join(""),V=U+Y+g.encode(X);J.console&&J.console.log(U,Y,X);var T=d.getElementById("webim-log")||d.body;J.air&&J.air.trace(V);if(T){var S=d.createElement("P");S.innerHTML=V;T.appendChild(S)}}i.enable=function(){P=true};i.disable=function(){P=false};function e(U,T){var S=this;S.options=k({},e.defaults,T);this._init(U,T)}k(e.prototype,u,{_init:function(){var S=this;S.data={user:{}};S.status=new e.status();S.setting=new e.setting();S.buddy=new e.buddy();S.room=new e.room();S.history=new e.history();S.notification=new e.notification();S.connection=new C(null,{jsonp:true});S._initEvents()},ready:function(){var S=this;S._unloadFun=J.onbeforeunload;J.onbeforeunload=function(){S.refresh()};S.trigger("ready")},go:function(){var T=this,W=T.data,Y=T.history,U=T.buddy,X=T.room;T.connection.connect(W.connection);Y.option("userInfo",W.user);Y.init(W.histories);U.handle(W.buddies);U.online(W.buddy_online_ids,true);var S=T.setting.get("block_list"),V=W.rooms;w(S)&&V&&L(S,function(ab,aa){V[aa]&&(V[aa].blocked=true)});X.handle(V);X.options.ticket=W.connection.ticket;var Z=W.new_messages;if(Z&&Z.length){T.trigger("message",[Z])}T.trigger("go",[W])},stop:function(T){var S=this;J.onbeforeunload=S._unloadFun;S.data.user.presence="offline";S.buddy.clear();S.trigger("stop",T)},autoOnline:function(){return !this.status.get("o")},_initEvents:function(){var U=this,S=U.status,V=U.setting,W=U.history,T=U.connection;T.bind("connect",function(Y,X){}).bind("data",function(X){U.handle(X)}).bind("error",function(X){U.stop("connect error")}).bind("close",function(X){U.stop("disconnect")})},handle:function(T){var S=this;T.messages&&T.messages.length&&S.trigger("message",[T.messages]);T.presences&&T.presences.length&&S.trigger("presence",[T.presences]);T.statuses&&T.statuses.length&&S.trigger("status",[T.statuses])},sendMsg:function(T){var S=this;T.ticket=S.data.connection.ticket;B({type:"post",url:S.options.urls.message,type:"post",cache:false,data:T})},sendStatus:function(T){var S=this;T.ticket=S.data.connection.ticket;B({type:"post",url:S.options.urls.status,type:"post",cache:false,data:T})},setStranger:function(S){this.stranger_ids=D(S)},stranger_ids:[],online:function(){var T=this,S=T.status,U=[],V=S.get("tabs"),X=S.get("tabIds");S.set("o",false);T.ready();X&&X.length&&V&&L(V,function(Z,Y){Y.t=="buddy"&&U.push(Z)});var W=c();B({type:"post",dataType:"json",data:{buddy_ids:U.join(","),stranger_ids:T.stranger_ids.join(","),room_ids:W},url:T.options.urls.online,success:function(Y){if(!Y||!Y.user||!Y.connection){T.stop("online error")}else{Y.user=k(T.data.user,Y.user);T.data=Y;T.go()}},error:function(Y){T.stop("online error")}})},offline:function(){var S=this,T=S.data;S.status.set("o",true);S.connection.close();S.stop("offline");B({type:"post",url:S.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:T.connection.ticket}})},refresh:function(){var S=this,T=S.data;if(!T||!T.connection||!T.connection.ticket){return}B({type:"post",url:S.options.urls.refresh,type:"post",cache:false,data:{ticket:T.connection.ticket}})}});function D(S){return S&&S.split?S.split(","):(w(S)?S:(parseInt(S)?[parseInt(S)]:[]))}function b(T,V,U){function S(Y,X){var W=this;W.data=Y;W.options=k({},S.defaults,X);r(W._init)&&W._init()}S.defaults=V;k(S.prototype,u,U);e[T]=S}J.webim=e;k(e,{version:"1.0.0pre",defaults:{},log:i,idsArray:D,now:K,isFunction:r,isArray:w,isObject:F,trim:a,makeArray:q,extend:k,each:L,inArray:M,grep:O,map:x,JSON:g,ajax:B,model:b,objectExtend:u});b("setting",{url:"/webim/setting",data:{play_sound:true,buddy_sticky:true,minimize_layout:false,msg_auto_pop:true}},{_init:function(){var S=this;S.data=k({},S.options.data,S.data)},get:function(S){return this.data[S]},set:function(W,Y){var U=this,V=W;if(!W){return}if(typeof W=="string"){V={};V[W]=Y}var T=U.data,S=R(T,V);if(S){L(S,function(Z,aa){U.trigger("update",[Z,aa])});var X=k({},T,V);U.data=X;B({type:"post",url:U.options.url,dataType:"json",cache:false,data:{data:g.encode(X)}})}}});b("status",{key:"_webim"},{_init:function(){var S=this,T=S.data;if(!T){var U=y(S.options.key);S.data=U?g.decode(U):{}}else{S._save(T)}},set:function(V,X){var U=V,T=this;if(typeof V=="string"){U={};U[V]=X}var S=T.data;if(R(S,U)){var W=k({},S,U);T._save(W)}},get:function(S){return this.data[S]},clear:function(){this._save({})},_save:function(S){this.data=S;y(this.options.key,g.encode(S),{path:"/",domain:d.domain})}});b("buddy",{url:"/webim/buddy"},{_init:function(){var S=this;S.data=S.data||[];S.dataHash={};S._cacheData={};S.handle(S.data)},clear:function(){var S=this;S.data=[];S.dataHash={};S._cacheData={}},count:function(X){var W=k({},this.dataHash,this._cacheData),V=0,U;for(var T in W){if(F(X)){U=true;for(var S in X){if(X[S]!=W[T][S]){U=false}}if(U){V++}}else{V++}}return V},get:function(S){return this.dataHash[S]},online:function(T,S){this.changeStatus(T,"online",true,S)},offline:function(S){this.changeStatus(S,"offline",false)},loadDelay:function(){var T=this,S=T._cacheData,U=[];for(var V in S){U.push(V)}T.load(U)},update:function(S){this.load(S)},changeStatus:function(S,ab,Z,V){S=D(S);var W=S.length;if(W){var ae=this,T=ae._cacheData,Y=ae.dataHash,ac=[],U,aa=[],ad;for(var X=0;X<W;X++){U=S[X];if(Y[U]){ac.push({id:U,presence:ab})}else{ad={id:U,presence:ab};if(!T[U]||T[U].presence!=ab){aa.push(ad)}if(Z){T[U]=ad}else{if(T[U]){delete T[U]}}}}ae.handle(ac);if(Z&&!V){ae.loadDelay()}else{if(aa.length){if(Z){ae.trigger(ab+"Delay",[aa])}else{ae.trigger(ab,[aa])}}}}},_loadSuccess:function(X){var U=this.self||this,T=U._cacheData,S=X.length,W,Y;for(var V in X){W=X[V];Y=W.id;if(T[Y]){k(W,T[Y]);delete T[Y]}}U.handle(X)},load:function(U){U=D(U);if(U.length){var S=this,T=S.options;B({url:T.url,cache:false,dataType:"json",data:{ids:U.join(",")},context:S,success:S._loadSuccess})}},handle:function(T){var ac=this,W=ac.data,X=ac.dataHash,U={};T=T||[];var S=T.length,aa,Y,ab;for(var V in T){aa=T[V],id=aa.id;if(id){if(!X[id]){X[id]={};W.push(X[id])}ab=R(X[id],aa);if(ab){Y=ab.presence||"update";U[Y]=U[Y]||[];k(X[id],ab);U[Y].push(X[id])}}}for(var Z in U){ac.trigger(Z,[U[Z]])}}});(function(){b("room",{urls:{join:"/webim/join.php",leave:"/webim/leave.php",member:"/webim/members.php"}},{_init:function(){var S=this;S.data=S.data||[];S.dataHash={}},get:function(S){return this.dataHash[S]},block:function(V){var S=this,U=S.dataHash[V];if(U&&!U.blocked){U.blocked=true;var T=[];L(S.dataHash,function(X,W){if(W.blocked){T.push(W.id)}});S.trigger("block",[V,T])}},unblock:function(V){var S=this,U=S.dataHash[V];if(U&&U.blocked){U.blocked=false;var T=[];L(S.dataHash,function(X,W){if(W.blocked){T.push(W.id)}});S.trigger("unblock",[V,T])}},handle:function(W){var T=this,V=T.data,U=T.dataHash,S={};L(W,function(Y,X){var Z=X.id;if(Z){X.members=X.members||[];X.count=X.count||0;X.all_count=X.all_count||0;if(!U[Z]){U[Z]=X;V.push(X)}else{k(U[Z],X)}T.trigger("join",[U[Z]])}})},addMember:function(V,X){var T=this;if(w(X)){L(X,function(aa,Z){T.addMember(V,Z)});return}var W=T.dataHash[V];if(W){var S=W.members,Y;for(var U=S.length;U--;U){if(S[U].id==X.id){Y=S[U]}}if(!Y){X.name=X.nick||X.name;S.push(X);W.members.length;T.trigger("addMember",[V,X])}}},removeMember:function(V,U){var W=this.dataHash[V];if(W){var S=W.members,X;for(var T=S.length;T--;T){if(S[T].id==U){X=S[T];S.splice(T,1);W.count--}}X&&self.trigger("removeMember",[V,X])}},initMember:function(T){var S=this.dataHash[T];if(S&&!S.initMember){S.initMember=true;this.loadMember(T)}},loadMember:function(U){var S=this,T=S.options;B({cache:false,url:T.urls.member,dataType:"json",data:{ticket:T.ticket,id:U},success:function(V){L(V,function(X,W){S.addMember(X,W)})}})},join:function(V,T){var S=this,U=S.options;B({cache:false,url:U.urls.join,dataType:"json",data:{ticket:U.ticket,id:V,nick:T.name},success:function(W){S.initMember(V);S.handle([W])}})},leave:function(W,T){var S=this,U=S.options,V=S.dataHash[W];if(V){V.initMember=false;B({cache:false,url:U.urls.leave,data:{ticket:U.ticket,id:W,nick:T.name}});S.trigger("leave",[V])}},clear:function(){}})})();b("notification",{url:"webim/notifications"},{grep:function(S,T){return S&&S.text},handle:function(T){var S=this;T=O(q(T),S.grep);if(T.length){S.trigger("data",[T])}},load:function(){var S=this,T=S.options;B({url:T.url,cache:false,dataType:"json",context:S,success:S.handle})}});b("history",{urls:{load:"",clear:""}},{_init:function(){this.data=this.data||{}},get:function(S){return this.data[S]},handle:function(W){var ac=this,Y=ac.data,T={};W=q(W);var V=W.length,ab,U,Z=ac.options.userInfo.id;if(!V){return}for(var X=0;X<V;X++){ab=W[X];U=ab.to==Z?ab.from:ab.to;if(U){T[U]=T[U]||[];T[U].push(ab)}}var S=[];for(var aa in T){var ab=T[aa];if(Y[aa]){Y[aa]=Y[aa].concat(ab);ac._triggerMsg(aa,ab)}else{S.push(aa)}}ac.load(S)},_triggerMsg:function(T,S){this.trigger("data",[T,S])},clear:function(W){W=D(W);var T=this,S=W.length,U=T.options,X;if(S){for(var V=0;V<S;V++){X=W[V];T.data[X]=[];T.trigger("clear",[X])}B({url:U.urls.clear,cache:false,dataType:"json",data:{ids:W.join(",")}})}},init:function(V){var T=this.self||this,S;for(var U in V){S=V[U];T.data[U]=S;T._triggerMsg(U,S)}},load:function(V){V=D(V);if(V.length){var S=this,T=S.options;for(var U=0;U<V.length;U++){S.data[V[U]]=[]}B({url:T.urls.load,cache:false,dataType:"json",data:{ids:V.join(",")},context:S,success:S.init})}}});b("hotpost",{url:"webim/hotpost"},{grep:function(S,T){return S&&S.text},handle:function(T){var S=this;T=O(q(T),S.grep);if(T.length){S.trigger("data",[T])}},load:function(){var S=this,T=S.options;B({url:T.url,cache:false,dataType:"json",context:S,success:S.handle})}})})(window,document);
/*
 * Webim UI v2.1.0pre
 * http://www.nextim.cn/
 *
 * Copyright (c) 2009 Hidden
 *
 * Date: 
 * Revision: 
 */
(function(V,j,r){var l=webim.log,R=webim.idsArray,Y=webim.now,v=webim.isFunction,B=webim.isArray,T=webim.isObject,d=webim.trim,t=webim.makeArray,q=webim.extend,ab=webim.each,ah=webim.inArray,al=webim.grep,y=webim.objectExtend,E=webim.map;function am(){return false}function x(ap){var ao="";if(ap.length==0){return""}ao=ap.replace(/&/g,"&gt;");ao=ao.replace(/</g,"&lt;");ao=ao.replace(/>/g,"&gt;");ao=ao.replace(/    /g,"&nbsp;");ao=ao.replace(/\'/g,"&#39;");ao=ao.replace(/\"/g,"&quot;");ao=ao.replace(/\n/g,"<br />");return ao}function s(ao){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(ao)}function U(ao,aw,au){if(!ao){return ao}var aq=0,ap=[],av=ao.split(""),at=av.length;for(var ar=0;ar<at;ar++){if(aq>=au||aq<aw){break}else{if(av[ar].charCodeAt(0)>255){aq+=2}else{aq++}ap.push(av[ar])}}return ap.join("")}function L(ao){return ao?(ao.nodeType?ao:j.getElementById(ao)):null}function ac(aq,ap){var ao=[];for(;aq;aq=aq.nextSibling){if(aq.nodeType==1&&aq!=ap){ao.push(aq)}}return ao}function w(ao){return ac(ao.firstChild)}function W(ap,ao){return ap&&(new RegExp("(^|\\s+)"+ao+"(\\s+|$)").test(ap.className))}function A(ap,ao){if(!ap){return}if(!W(ap,ao)){ap.className+=" "+ao}}function u(ap,ao){ap&&(ap.className=ap.className.replace(new RegExp("(^|\\s+)("+ao.split(/\s+/).join("|")+")(\\s+|$)","g")," "))}function aa(aq,ao,ap){aq&&(aq.className=aq.className.replace(new RegExp("(^|\\s+)("+ao.split(/\s+/).join("|")+")(\\s+|$)","g")," ")+" "+ap)}function p(aq,ap,ao){m(aq,"mouseover",function(){A(this,ap);ao&&(u(this,ao))});m(aq,"mouseout",function(){u(this,ap);ao&&(A(this,ao))})}function h(aq,ao,ap){if(typeof ap==="boolean"){ap?A(aq,ao):u(aq,ao)}else{W(aq,ao)?u(aq,ao):A(aq,ao)}}function Q(ao){ao&&ao.style&&(ao.style.display="block")}function ad(ao){ao&&ao.style&&(ao.style.display="none")}function D(ao){ao&&ao.parentNode&&(ao.parentNode.removeChild(ao))}function m(aq,ap,ao){if(aq.addEventListener){aq.addEventListener(ap,ao,false)}else{aq["e"+ap+ao]=ao;aq[ap+ao]=function(){return aq["e"+ap+ao](V.event)};aq.attachEvent("on"+ap,aq[ap+ao])}}function f(aq,ap,ao){if(aq.addEventListener){aq.removeEventListener(ap,ao,false)}else{aq.detachEvent("on"+ap,aq[ap+ao]);aq[ap+ao]=null}}function P(ao){if(!ao){return}ao.stopPropagation&&ao.stopPropagation();ao.cancelBubble=true}function N(ao){if(!ao){return}ao.preventDefault&&ao.preventDefault();ao.returnValue=false}function c(ao){if(!ao.target){ao.target=ao.srcElement||j}if(ao.target.nodeType===3){ao.target=ao.target.parentNode}return ao.target}function J(ao){ao.setAttribute("unselectable","off");ao.style.MozUserSelect="";f(ao,"selectstart",am)}function X(ao){ao.setAttribute("unselectable","on");ao.style.MozUserSelect="none";m(ao,"selectstart",am)}function k(ao){S();if(z){ao()}else{C.push(ao)}}var z=false,C=[];function b(){if(!z){z=true;if(C){var ap,ao=0;while((ap=C[ao++])){ap()}C=null}}}var a=false;function S(){if(a){return}a=true;if(j.readyState==="complete"){return b()}if(j.addEventListener){j.addEventListener("DOMContentLoaded",function(){j.removeEventListener("DOMContentLoaded",arguments.callee,false);b()},false)}else{if(j.attachEvent){j.attachEvent("onreadystatechange",function(){if(j.readyState==="complete"){j.detachEvent("onreadystatechange",arguments.callee);b()}});if(j.documentElement.doScroll&&V==V.top){(function(){if(z){return}try{j.documentElement.doScroll("left")}catch(ao){setTimeout(arguments.callee,0);return}b()})()}}}m(V,"load",b)}function ag(ao){var ap=(new Date());ap.setTime(ao?(parseFloat(ao)+ag.timeSkew):(new Date()).getTime());this.date=ap}ag.timeSkew=0;ag.init=function(ao){ag.timeSkew=(new Date()).getTime()-parseFloat(ao)};q(ag.prototype,{getTime:function(){var aq=this.date;var ao=aq.getHours();var ap="";var ar=aq.getMinutes();if(ar<10){ar="0"+ar}var at=ao+":"+ar+ap;return at},getDay:function(ap){var ar=this.date;if(ap){var ao=new Date();ao.setHours(0);ao.setMinutes(0);ao.setSeconds(0);ao.setMilliseconds(0);var aq=24*60*60*1000;var at=ao.getTime()-ar.getTime();if(at<=0){return an("dt:today")}else{if(at<aq){return an("dt:yesterday")}}}return an("dt:monthdate",{month:an(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][ar.getMonth()]),date:ar.getDate()})}});var I=(function(){var aq=true;var ap=function(ar){try{j.getElementById("webim-flashlib").playSound(ar?ar:"/sound/sound.mp3")}catch(at){}};var ao={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){aq=true},disable:function(){aq=false},init:function(av){q(ao,av);var ar=ao.lib+"?_"+new Date().getTime();if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){var at='<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+ar+'" />'}else{var at='<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+ar+'">				<param name="allowScriptAccess" value="always" />				<param name="movie" value="'+ar+'" />				<param name="scale" value="noscale" />				</object>'}try{j.getElementById("webim-flashlib-c").innerHTML=at}catch(au){}},play:function(at){var ar=s(at)?at:ao[at];aq&&ap(ar)}}})();var H=(function(){var aq=false;m(V,"focus",function(){aq=false});m(V,"blur",function(){aq=true});var ar=j.title,ao=0,ap=false,at=null;return function(av,au){if(!aq){return}if(aw){clearInterval(aw);ao=0;ap=false}var aw=setInterval(function(){ao++;ap=!ap;if(ao==au||!aq){clearInterval(aw);ao=0;ap=false}if(ap){j.title="["+av+"]"+ar}else{j.title=ar}},1500)}})();var Z={};var o=function(ap,ao){return Z[ao]||""};function an(aq,ap,ao){ao=q({locale:an.locale},ao);var au=an.dictionary[ao.locale];if(!T(au)){au={}}var at=au[aq]===r?aq:au[aq];if(ap){Z=ap;for(var ar in ap){at=at.replace(/\{\{(.*?)\}\}/g,o)}}return at}an.locale="zh-CN";an.dictionary={};an.store=function(ao,ap){var aq=an.dictionary;if(!T(aq[ao])){aq[ao]={}}q(aq[ao],ap)};function F(aq,ap){var ao=this;ao.element=aq;ao.options=q({},F.defaults,ap);ao._init()}q(F.prototype,y,{_init:function(){var ap=this,ao=ap.im=new webim(),at=ap.layout=new F.layout(null,{chatAutoPop:ao.setting.get("msg_auto_pop")}),aq=ap.options;ap.notification=new F.notification();var au=ao.setting.data;ap.setting=new F.setting(null,{data:{buddy_sticky:au.buddy_sticky,play_sound:au.play_sound,msg_auto_pop:au.msg_auto_pop,minimize_layout:au.minimize_layout}});ap.buddy=new F.buddy(null,{});var ar=ap.options.menu;ap.menu=new F.menu(null,{data:ar});at.addApp(ap.menu,{title:an("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut");at.addShortcut(ar);at.addApp(ap.buddy,{title:an("chat"),icon:"buddy",sticky:ao.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!ao.status.get("b"),titleVisibleLength:19});at.addApp(ap.notification,{title:an("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});at.addApp(ap.setting,{title:an("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});ao.setting.get("play_sound")?I.enable():I.disable();ao.setting.get("minimize_layout")?at.collapse():at.expand();ap.buddy.offline();ap._initEvents()},addApp:function(ap){var aq=F.apps[ap];if(!aq){return}var ao=this;v(aq.init)&&aq.init.apply(ao,[]);ao.im.bind("ready",function(){v(aq.ready)&&aq.ready.apply(ao,[])}).bind("go",function(){v(aq.go)&&aq.go.apply(ao,[])}).bind("stop",function(){v(aq.stop)&&aq.stop.apply(ao,[])})},initSound:function(ao){I.init(ao||this.options.soundUrls)},_initEvents:function(){var aC=this,aw=aC.im,av=aw.buddy,au=aw.history,aq=aw.status,aD=aw.setting,aB=aC.buddy,aE=aw.chatlink,ar=aC.layout,at=aC.notification,aA=aC.setting,ao=aw.room;aw.bind("ready",function(){ar.changeState("ready");Q(ar.app("room").window.element);aB.online();aA.online()}).bind("go",function(aF){ar.changeState("active");ar.option("user",aF.user);ag.init(aF.server_time);aC._initStatus();!aB.window.isMinimize()&&av.loadDelay();aB.notice("count",av.count({presence:"online"}));aD.set(aF.setting)}).bind("stop",function(aF){ar.changeState("stop");ad(ar.app("room").window.element);aF=="offline"&&ar.removeAllChat();ar.updateAllChat();aB.offline();aF&&aB.notice(aF);aA.offline()});aD.bind("update",function(aF,aG){switch(aF){case"buddy_sticky":aB.window.option("sticky",aG);aA.check_tag(aF,aG);break;case"play_sound":(aG?I.enable():I.disable());aA.check_tag(aF,aG);break;case"msg_auto_pop":ar.option("chatAutoPop",aG);aA.check_tag(aF,aG);break;case"minimize_layout":aA.check_tag(aF,aG);(aG?ar.collapse():ar.expand());break}});aA.bind("change",function(aF,aG){aD.set(aF,aG)});aA.bind("offline",function(){aw.trigger("stop");aw.offline()});aA.bind("online",function(){aw.trigger("ready");aw.online()});ar.bind("collapse",function(){aD.set("minimize_layout",true)});ar.bind("expand",function(){aD.set("minimize_layout",false)});ar.bind("displayUpdate",function(aF){aC._updateStatus()});aB.bind("select",function(aF){aC.addChat(aF.id,{type:"buddy"})}).bind("online",function(){aw.online()});aB.window.bind("displayStateChange",function(aF){if(aF!="minimize"){av.loadDelay()}});av.bind("online",function(aF){aB.add(aF);ar.updateChat(aF);aB.notice("count",av.count({presence:"online"}))});av.bind("onlineDelay",function(aF){aB.notice("count",av.count({presence:"online"}))});var az=function(aF){return T(aF)?aF.id:aF};av.bind("offline",function(aF){aB.remove(E(aF,az));ar.updateChat(aF);aB.notice("count",av.count({presence:"online"}))});av.bind("update",function(aF){aB.update(aF);ar.updateChat(aF)});aw.bind("message",function(aJ){var aP=false,aR=this.room.dataHash,aH=aJ.length,aM,aL=aw.data.user.id,aG,aN,aQ=[],aK="+1";for(var aI=0;aI<aH;aI++){aM=aJ[aI];aG=aM.to==aL?aM.from:aM.to;if(!aM["new"]){aQ.push(aG)}aN=ar.chat(aG);aN&&aN.status("");if(!aN){var aO=(aM.type==="unicast")?aM.nick:aR[aG].name;if(aM.type==="unicast"){aC.addChat(aG,null,null,aO)}else{aC.addChat(aG,{type:"room"})}aN=ar.chat(aG)}aN&&aD.get("msg_auto_pop")&&!ar.activeTabId&&ar.focusChat(aG);aN.window.notifyUser("information",aK);var aF=aN.window.pos;(aF==-1)&&ar.setNextMsgNum(aK);(aF==1)&&ar.setPrevMsgNum(aK);if(aM.from!=aL){aP=true}}if(aP){I.play("msg");H(an("new message"),5)}au.handle(aJ);av.online(aQ,1)});function ay(aF){return aF.type=="offline"}function ax(aF){return aF.type=="online"}function ap(aF){return aF.from}aw.bind("presence",function(aF){offline=al(aF,ay);online=al(aF,ax);av.online(E(online,ap),aB.window.isMinimize());av.offline(E(offline,ap));online.length&&aB.notice("buddyOnline",online.pop()["nick"])});aw.bind("status",function(aF){ab(aF,function(aL,aI){var aH=aw.data.user.id;var aK=aI.from;if(aH!=aI.to&&aH!=aI.from){aK=aI.to;var aG=aI.nick}else{var aJ=ar.chat(aK);aJ&&aJ.status(aI.show)}})});au.bind("data",function(aI,aG){var aH=ar.chat(aI),aF="+"+aG.length;if(aH){aH.history.add(aG)}});au.bind("clear",function(aG){var aF=ar.chat(aG);aF&&aF.history.clear()});aw.notification.bind("data",function(aF){at.window.notifyUser("information","+"+aF.length);at.add(aF)});setTimeout(function(){aw.notification.load()},2000)},__status:false,_initStatus:function(){var aq=this,at=aq.layout;if(aq.__status){return at.updateAllChat()}aq.__status=true;var ap=aq.im.status,ar=ap.get("tabs"),av=ap.get("tabIds"),au=ap.get("p"),ao=ap.get("a");av&&av.length&&ar&&ab(ar,function(ax,aw){aq.addChat(ax,{type:aw.t},{isMinimize:true});at.chat(ax).window.notifyUser("information",aw.n)});au&&(at.prevCount=au)&&at._fitUI();ao&&at.focusChat(ao)},addChat:function(aq,aC,at,ap){var aA=this,av=aA.layout,ay=aA.im,aw=aA.im.history,ax=ay.buddy,ao=ay.room;if(av.chat(aq)){return}if(aC&&aC.type=="room"){var au=aw.get(aq),ar=ao.get(aq),az=ar||{id:aq,name:ap||aq};az.presence="online";av.addChat(az,q({history:au,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"},aC),at);if(!au){aw.load(aq)}var aB=av.chat(aq);aB.bind("sendMsg",function(aD){ay.sendMsg(aD);aw.handle(aD)}).bind("select",function(aD){ax.online(aD.id,1);aA.addChat(aD.id,{type:"buddy"},null,aD.name);av.focusChat(aD.id)}).bind("block",function(aD){ao.block(aD.id)}).bind("unblock",function(aD){ao.unblock(aD.id)}).window.bind("close",function(){aB.options.info.blocked&&ao.leave(aq)});setTimeout(function(){if(aB.options.info.blocked){ao.join(aq)}else{ao.initMember(aq)}},500);B(ar.members)&&ab(ar.members,function(aE,aD){aB.addMember(aD.id,aD.name,aD.id==ay.data.user.id)})}else{var au=aw.get(aq),ar=ax.get(aq);var az=ar||{id:aq,name:ap||aq};av.addChat(az,q({history:au,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},aC),at);if(!ar){ax.update(aq)}if(!au){aw.load(aq)}av.chat(aq).bind("sendMsg",function(aD){ay.sendMsg(aD);aw.handle(aD)}).bind("sendStatus",function(aD){ay.sendStatus(aD)}).bind("clearHistory",function(aD){aw.clear(aD.id)})}},_updateStatus:function(){var ap=this,ar=ap.layout,ao={},aq=ar.panels;ab(ar.tabs,function(av,au){ao[av]={n:au._count(),t:aq[av].options.type}});var at={tabs:ao,tabIds:ar.tabIds,p:ar.prevCount,a:ar.activeTabId,b:ar.app("buddy").window.isMinimize()?0:1};ap.im.status.set(at)}});var g=function(ao,ap){if(ap===r){return parseInt(ao.innerHTML)}else{if(ap){ap=(typeof ap=="number")?ap:(parseInt(ao.innerHTML)+parseInt(ap));ao.innerHTML=ap.toString();Q(ao)}else{ao.innerHTML="0";ad(ao)}}return ap};function i(av){var at=av.getElementsByTagName("*"),ar,aw,aq={},au=":",ao=au.length;for(var ap=at.length-1;ap>-1;ap--){ar=at[ap];aw=ar.id;if(aw&&aw.indexOf(au)==0){aq[aw.substring(ao,aw.length)]=ar}}return aq}function G(ap){var ao=j.createElement("div");ao.innerHTML=ap;ao=ao.firstChild;return ao}var ae=(function(){var aq=null,ap=/\<\%\=(.*?)\%\>/ig;function ao(at,ar){return aq&&aq[ar]!=r?aq[ar]:an(ar)}return function(at,ar){if(!at){return""}aq=ar;return at.replace(ap,ao)}})();var aj={add:function(ap,aq,at){var ar=F[ap].prototype;for(var ao in at){ar.plugins[ao]=ar.plugins[ao]||[];ar.plugins[ao].push([aq,at[ao]])}},call:function(ao,aq,ap){var at=ao.plugins[aq];if(!at||!ao.element.parentNode){return}for(var ar=0;ar<at.length;ar++){if(ao.options[at[ar][0]]){at[ar][1].apply(ao.element,ap)}}}};var M=1;function K(aq,ar,ap){function ao(av,au){var at=this;at.id=M++;at.name=aq;at.className="webim-"+aq;at.options=q({},ao.defaults,au);at.element=av||(at.template&&G(at.template()))||(at.options.template&&G(ae(at.options.template)));if(at.element){at.options.className&&A(at.element,at.options.className);at.$=i(at.element)}v(at._init)&&at._init();v(at._initEvents)&&at._initEvents()}ao.defaults=ar;q(ao.prototype,y,K.prototype,ap);F[aq]=ao}q(K.prototype,{_init:function(){}});function e(ao,ap){F.apps[ao]=ap||{}}q(F,{version:"2.1.0pre",widget:K,app:e,plugin:aj,i18n:an,date:ag,ready:k,createElement:G,apps:{}});webim.ui=F;K("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-chat"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">						<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},{html:function(ao){return this.$.content.appendChild(ao)},_init:function(aq,ap){var ao=this,ap=ao.options,ar=ao.$;aq=ao.element;aq.window=ao;ap.tabWidth&&(ar.tab.style.width=ap.tabWidth+"px");ao.title(ap.title,ap.icon);!ap.minimizable&&ad(ar.minimize);!ap.maximizable&&ad(ar.maximize);if(!ap.closeable){ad(ar.tabClose);ad(ar.close)}if(ap.isMinimize){ao.minimize()}else{ao.restore()}if(ap.onlyIcon){ad(ar.tabTitle)}else{D(ar.tabTip)}ap.count&&ao.notifyUser("information",ap.count);ak(ao)},notifyUser:function(ap,aq){var ao=this,ar=ao.$;if(ap=="information"){if(ao.isMinimize()){if(g(ar.tabCount,aq)){A(ar.tab,"ui-state-highlight");u(ar.tab,"ui-state-default")}}}},_count:function(){return g(this.$.tabCount)},title:function(au,aq){var ao=this,ar=ao.$,at=ar.tabIcon;if(aq){if(s(aq)){at.className="webim-icon";at.style.backgroundImage="url("+aq+")"}else{at.className="webim-icon webim-icon-"+aq}}ar.tabTipC.innerHTML=au;var ap=U(au,0,ao.options.titleVisibleLength);ar.tabTitle.innerHTML=ap;ap&&au&&ap.length<au.length&&ar.tabTitle.setAttribute("title",au);ar.headerTitle.innerHTML=au},_changeState:function(aq){var ap=this.element,ao=aq=="restore"?"normal":aq;aa(ap,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+ao);this.trigger("displayStateChange",[aq])},active:function(){return W(this.element,"webim-window-active")},activate:function(){var ao=this;if(ao.active()){return}A(ao.element,"webim-window-active");ao.trigger("activate")},deactivate:function(){var ao=this;if(!ao.active()){return}u(ao.element,"webim-window-active");if(!ao.options.sticky){ao.minimize()}ao.trigger("deactivate")},_setVisibile:function(){var ao=this,ap=ao.$;aa(ap.tab,"ui-state-default ui-state-highlight","ui-state-active");ao.activate();g(ap.tabCount,0)},maximize:function(){var ao=this;if(ao.isMaximize()){return}ao._setVisibile();ao._changeState("maximize")},restore:function(){var ao=this;if(W(ao.element,"webim-window-normal")){return}ao._setVisibile();ao._changeState("restore")},minimize:function(){var ao=this;if(ao.isMinimize()){return}aa(ao.$.tab,"ui-state-active","ui-state-default");ao.deactivate();ao._changeState("minimize")},tabClose:function(){this.close()},close:function(){var ao=this;ao.trigger("close");D(ao.element)},_initEvents:function(){var ao=this,aq=ao.element,at=ao.$,ar=at.tab;var ap=function(av){P(av);N(av)};var au=function(av){ao.minimize()};m(at.header,"click",au);m(ar,"click",function(av){if(ao.isMinimize()){ao.restore()}else{ao.minimize()}ap(av)});m(ar,"mouseover",function(){A(this,"ui-state-hover");u(this,"ui-state-default")});m(ar,"mouseout",function(){u(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&A(this,"ui-state-default")});m(ar,"mousedown",ap);X(ar);ab(["minimize","maximize","close","tabClose"],function(aw,av){m(at[av],"click",function(ax){if(!this.disabled){ao[av]()}ap(ax)});m(at[av],"mousedown",ap)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(ao){return},isMaximize:function(){return W(this.element,"webim-window-maximize")},isMinimize:function(){return W(this.element,"webim-window-minimize")}});var ak=(function(){var ao=false;var at=function(){ao&&ao.deactivate();ao=false;return true};var aq=function(av){var au=this;au&&au!=ao&&at()&&(ao=au)};var ar=function(av){var au=this;au&&ao==au&&(ao=false)};var ap=function(au){if(au.active()){at();ao=au}au.bind("activate",aq);au.bind("deactivate",ar)};m(j,"mousedown",function(aw){aw=c(aw);var au;while(aw){if(aw.id==":webim-window"){au=aw;break}else{aw=aw.parentNode}}if(au){var av=au.window;av&&av.activate()}else{at()}});return function(au){ap(au)}})();K("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":apps" class="webim-apps">                            </div>                            </div>            </div></div>                    </div>',shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},{_init:function(aq,ap){var ao=this,ap=ao.options;q(ao,{window:V,apps:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});ap.isMinimize&&ao.collapse()},changeState:function(ao){this.element.className="webim webim-state-"+ao},_ready:false,buildUI:function(ar){var ap=this,aq=ap.$;var ao=(ai()-45)-aq.shortcut.offsetWidth-aq.apps.offsetWidth-70;ap.maxVisibleTabs=parseInt(ao/ap.tabWidth);ap._fitUI();ap._ready=true},_updatePrevCount:function(ap){var ax=this,au=ax.tabIds,av=ax.maxVisibleTabs,at=au.length,ao=ap,ar=ax.prevCount;if(at<=av){return}if(!ao){ar=at-av}else{var aw=0;for(var aq=0;aq<at;aq++){if(au[aq]==ao){aw=aq;break}}if(aw<=ar){ar=aw}else{if(aw>=ar+av){ar=aw-av+1}}}ax.prevCount=ar},_setVisibleTabs:function(ay){var aA=this,az=aA.prevCount,ap=az+aA.maxVisibleTabs,ax=aA.tabs,aw=aA.tabIds;var av=aw.length,au=0,ao=0;for(var at=0;at<av;at++){var ar=ax[aw[at]];if(at<az||at>=ap){if(ay){Q(ar.element)}else{if(aA.activeTabId==aw[at]){ar.minimize()}var aq=ar._count();if(at<az){ao+=aq;ar.pos=1}else{au+=aq;ar.pos=-1}ad(ar.element)}}else{ar.pos=0;Q(ar.element)}}if(!ay){aA.setNextMsgNum(au);aA.setPrevMsgNum(ao)}},setNextMsgNum:function(ao){g(this.$.nextMsgCount,ao)},setPrevMsgNum:function(ao){g(this.$.prevMsgCount,ao)},slideing:false,_slide:function(ax){var az=this,ay=az.prevCount,at=az.nextCount;if((at>0&&ax==-1)||(ay>0&&ax==1)){az.slideing=true;if(at==1&&ax==-1||ay==1&&ax==1){az.slideing=false}az._slideSetup(false);az._setVisibleTabs(true);if(ax==-1){az.nextCount--;az.prevCount++}else{if(ax==1){az.nextCount++;az.prevCount--}}var aw=az.$.tabs,av=parseFloat(aw.style.left),aq=-1*az.tabWidth*az.nextCount,ao=parseInt(500/13),au=1,ar=(aq-av)/ao;var ap=setInterval(function(){aw.style.left=av+ar*au+"px";if(au==ao){if(az.slideing){az._slide(ax)}else{az._fitUI();az._slideReset()}clearInterval(ap);return}au++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(ar){var ap=this,at=ap.$,ao=at.tabsWrap,aq=at.tabs;if(!ap._tabsWidth){ap._tabsWidth=aq.clientWidth}if(ar){ap._tabsWidth=null}ao.style.position=ar?"":"relative";ao.style.overflow=ar?"visible":"hidden";ao.style.width=ar?"":ap._tabsWidth+"px";aq.style.width=ar?"":ap.tabWidth*ap.tabIds.length+"px";aq.style.position=ar?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var aq=this,au=aq.tabIds,ap=aq.maxVisibleTabs,ao=au.length,ar=aq.prevCount,at=aq.nextCount;if(ao<=ap){at=0;ar=0}else{at=ao-ap-ar;at=at<0?0:at;ar=ao-ap-at}aq.prevCount=ar;aq.nextCount=at},_updateCountUI:function(){var ao=this,aq=ao.$,ap=ao.prevCount,ar=ao.nextCount;if(ar<=0){A(aq.next,"ui-state-disabled")}else{u(aq.next,"ui-state-disabled")}if(ap<=0){A(aq.prev,"ui-state-disabled")}else{u(aq.prev,"ui-state-disabled")}if(ap>0||ar>0){aq.next.style.display="block";aq.prev.style.display="block"}else{ad(aq.next);ad(aq.prev)}aq.nextCount.innerHTML=ar.toString();aq.prevCount.innerHTML=ap.toString()},_initEvents:function(){var ao=this,aq=ao.window,ap=ao.$;m(aq,"resize",function(){ao.buildUI()});m(ap.next,"mousedown",function(){ao._slide(-1)});m(ap.next,"mouseup",function(){ao._slideUp()});X(ap.next);m(ap.prev,"mousedown",function(){ao._slide(1)});m(ap.prev,"mouseup",function(){ao._slideUp()});X(ap.prev);m(ap.expand,"click",function(){ao.expand();return false});m(ap.collapse,"click",function(){ao.collapse();return false});p(ap.collapse,"ui-state-hover","ui-state-default");p(ap.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return W(this.$.layout,"webim-layout-minimize")},collapse:function(){var ao=this;if(ao.isMinimize()){return}A(this.$.layout,"webim-layout-minimize");ao.trigger("collapse")},expand:function(){var ao=this;if(!ao.isMinimize()){return}u(ao.$.layout,"webim-layout-minimize");ao.trigger("expand")},_displayUpdate:function(ao){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){var ao=this,aq=ao.$,ap=aq.apps;ao._updateCount();ao.$.tabs.style.left=-1*ao.tabWidth*ao.nextCount+"px";ao._updateCountUI();ao._setVisibleTabs();ao._displayUpdate()},_stickyWin:null,_appStateChange:function(aq,ap){var ao=this;if(ap!="minimize"){ab(ao.apps,function(ar,at){if(at.window!=aq){at.window.minimize()}})}ao._displayUpdate()},app:function(ao){return this.apps[ao]},addApp:function(av,aq,at,ao){var ap=this,aq=q(aq,{closeable:false});var au,ar=av.element;au=new F.window(null,aq);au.html(ar);ap.$[ao?ao:"apps"].insertBefore(au.element,at&&ap.apps[at]?ap.apps[at].window.element:null);av.window=au;au.bind("displayStateChange",function(aw){ap._appStateChange(this,aw)});ap.apps[av.name]=av},focusChat:function(ar){var ap=this,aq=ap.tabs[ar],ao=ap.panels[ar];aq&&aq.isMinimize()&&aq.restore();ao&&ao.focus()},chat:function(ao){return this.panels[ao]},updateChat:function(at){at=t(at);var aq=this,au,ap=at.length,ao;for(var ar=0;ar<ap;ar++){au=at[ar];ao=aq.panels[au.id];ao&&ao.update(au)}},updateAllChat:function(){ab(this.panels,function(ap,ao){ao.update()})},_onChatClose:function(ap){var ao=this;ao.tabIds=al(ao.tabIds,function(aq,ar){return aq!=ap});delete ao.tabs[ap];delete ao.panels[ap];ao._changeActive(ap,true);ao._fitUI()},_onChatChange:function(aq,ap){var ao=this;if(ap=="minimize"){ao._changeActive(aq,true);ao._displayUpdate()}else{ao._changeActive(aq);ao._fitUI()}},_changeActive:function(ar,aq){var ap=this,ao=ap.activeTabId;if(aq){ao==ar&&(ap.activeTabId=null)}else{ao&&ao!=ar&&ap.tabs[ao].minimize();ap.activeTabId=ar;ap._updatePrevCount(ar)}},addChat:function(av,ar,at){var ap=this,aq=ap.panels,aw=av.id,ao;if(!aq[aw]){var au=ap.tabs[aw]=new F.window(null,q({isMinimize:ap.activeTabId||!ap.options.chatAutoPop,tabWidth:ap.tabWidth-2},at)).bind("close",function(){ap._onChatClose(aw)}).bind("displayStateChange",function(ax){ap._onChatChange(aw,ax)});ap.tabIds.push(aw);ap.$.tabs.insertBefore(au.element,ap.$.tabs.firstChild);ao=aq[aw]=new F.chat(null,q({window:au,user:ap.options.user,info:av},ar));!au.isMinimize()&&ap._changeActive(aw);ap._fitUI()}},removeChat:function(at){at=R(at);var ap=this,au,ao=at.length,ar;for(var aq=0;aq<ao;aq++){ar=ap.tabs[at[aq]];ar&&ar.close()}},removeAllChat:function(){this.removeChat(this.tabIds)},addShortcut:function(ar){var ap=this;if(B(ar)){ab(ar,function(au,at){ap.addShortcut(at)});return}if(!T(ar)){return}var aq=ap.$.shortcut,ao=ap.options.tpl_shortcut;if(aq.childNodes.length>ap.options.shortcutLength+1){return}ao=G(ae(ao,{title:an(ar.title),icon:ar.icon,link:ar.link,target:ar.isExtlink?"_blank":""}));p(ao.firstChild,"ui-state-hover");aq.appendChild(ao)},addWindow:function(){new F.window(null,{})},online:function(){var ao=this,ap=ao.$},offline:function(){var ao=this,ap=ao.$}});function ai(){return j.compatMode==="CSS1Compat"&&j.documentElement.clientWidth||j.body.clientWidth}K("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(ap){var ao=this,aq=ao.element;ab(aq.firstChild.childNodes,function(at,ar){m(ar,"click",function(au){u(aq,"webim-emot-show");ao.trigger("select",this.firstChild.getAttribute("alt"))})})},template:function(){var ap=this,aq=ap.emots=webim.ui.emot.emots;var ao=[];ao.push('<ul class="ui-helper-clearfix">');ab(aq,function(av,ar){var au=ar.src,at=ar.t?ar.t:ar.q[0];ao.push('<li><img src="');ao.push(au);ao.push('" title="');ao.push(at);ao.push('" alt="');ao.push(ar.q[0]);ao.push('" /></li>')});ao.push("</ul>");return ae(ap.options.template,{emots:ao.join("")})},toggle:function(){h(this.element,"webim-emot-show")}});q(F.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(ap){var aq=webim.ui.emot,ar=aq._q={};ap=q({dir:"webim/static/emot/default"},ap);if(ap.emots){aq.emots=ap.emots}var ao=ap.dir+"/";ab(aq.emots,function(au,at){if(at&&at.src){at.src=ao+at.src}at&&at.q&&ab(at.q,function(aw,av){ar[av]=au})})},parse:function(aq){var ap=webim.ui.emot._q,ao=webim.ui.emot.emots;ap&&ab(ap,function(ax,at){var au=ao[at],aw=au.src,av=au.t?au.t:au.q[0],ar=[];ar.push('<img src="');ar.push(aw);ar.push('" title="');ar.push(av);ar.push('" alt="');ar.push(au.q[0]);ar.push('" />');ax=x(ax);ax=ax.replace(new RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");aq=aq.replace(new RegExp(ax,"g"),ar.join(""))});return aq}});e("chatlink",{init:function(){var aq=this,ao=aq.im;var ap=aq.chatlink=new webim.ui.chatlink(null).bind("select",function(at){aq.addChat(at);aq.layout.focusChat(at)});ao.buddy.bind("online",function(at){ap.online(ar(at))}).bind("onlineDelay",function(at){ap.online(ar(at))}).bind("offline",function(at){ap.offline(ar(at))});ao.setStranger(ap.idsArray());function ar(at){return webim.map(at,function(au,av){return au.id})}},ready:function(){this.chatlink.enable()},go:function(){this.chatlink.remove(this.im.data.user.id)},stop:function(){this.chatlink.disable();this.chatlink.offline(this.chatlink.idsArray())}});K("chatlink",{filterId:function(ap){if(!ap){return false}var ao=/space\.php\?uid=(\d+)$|space\-(\d+)\.html$/i.exec(ap);return ao&&(ao[1]||ao[2])},offline:true},{_init:function(){var aB=this,aw=aB.element,ao={},aC=aB.options,at=aC.filterId,ax={},ay=aC.offline;var aA=j.getElementsByTagName("a"),az;aA&&ab(aA,function(aD,aE){var aG=at(aE.href),aF=aE.innerHTML;if(aG&&w(aE).length==0&&aF){ao[aG]=true;az=aB._temp({id:aG,title:an("chat with",{name:aF}),title2:""});aE.parentNode.insertBefore(az,aE.nextSibling);ax[aG]?ax[aG].push(az):(ax[aG]=[az])}});var ap=at(V.location.href);if(ap){ao[ap]=true;var aq=aB._temp({id:ap,title:"",title2:"<a href='javascript:void 0'>"+an("chat with me")+"</a>"});u(aq,"webim-chatlink-disable");az=j.createElement("li");az.className="webim-chatlink-disable";az.appendChild(aq);var au=j.getElementsByTagName("*"),ar=au.length;for(var av=0;av<ar;av++){aq=au[av],n=aq.className;if(n.indexOf("spacemenu_list")!=-1||n.indexOf("line_list")!=-1){aq.appendChild(az);break}}ax[ap]?ax[ap].push(az):(ax[ap]=[az])}aB.ids=ao;aB.anthors=ax},_temp:function(ao){var ap=this;var aq=G(ae('<span id="<%=id%>" title="<%=title%>" class="webim-chatlink-disable webim-chatlink'+(ap.options.offline?"":" webim-chatlink-no-offline")+'"><span class="webim-chatlink-off-i"></span></span>',ao));m(aq,"click",function(ar){ap.trigger("select",this.id);P(ar);N(ar)});return aq},idsArray:function(){var ao=[];ab(this.ids,function(aq,ap){ao.push(aq)});return ao},disable:function(){var ao=this,aq=ao.ids;for(var ar in aq){var ap=ao.anthors[ar];ap&&ab(ap,function(au,at){A(at,"webim-chatlink-disable")})}},enable:function(){var ao=this,aq=ao.ids;for(var ar in aq){var ap=ao.anthors[ar];ap&&ab(ap,function(au,at){u(at,"webim-chatlink-disable")})}},remove:function(at){at=R(at);var ap=this,ao=at.length,au;for(var ar=0;ar<ao;ar++){au=at[ar];var aq=ap.anthors[au];if(aq){ab(aq,function(aw,av){D(av)});delete ap.anthors[au];delete ap.ids[au]}}},online:function(at){at=R(at);var ap=this,ao=at.length;for(var ar=0;ar<ao;ar++){var aq=ap.anthors[at[ar]];aq&&ab(aq,function(av,au){A(au,"webim-chatlink-on")})}},offline:function(at){at=R(at);var ap=this,ao=at.length;for(var ar=0;ar<ao;ar++){var aq=ap.anthors[at[ar]];aq&&ab(aq,function(av,au){u(au,"webim-chatlink-off")})}},updateUI:function(ap,ao){}});K("setting",{template:'<div id="webim-setting" class="webim-setting">                        <ul id=":ul"><%=tags%></ul>                        <div id=":offline" class="webim-setting-offline"><a href="#offline"><%=offline%></a></div>                        <div id=":online" class="webim-setting-online"><a href="#online"><%=online%></a></div>                  </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var ap=this,ao=[],aq=ap.options.data;aq&&ab(aq,function(ar,at){ao.push(ap._check_tpl(ar,at))});return ae(ap.options.template,{tags:ao.join("")})},_initEvents:function(){var ao=this,aq=ao.options.data,ap=ao.$;aq&&ab(aq,function(ar,at){ap[ar]&&ao._check_event(ap[ar])});m(ap.offline,"click",function(ar){ao.trigger("offline")});m(ap.online,"click",function(ar){ao.trigger("online")})},offline:function(){var ao=this.$;ad(ao.offline);Q(ao.online)},online:function(){var ao=this.$;Q(ao.offline);ad(ao.online)},_check_tpl:function(ao,ap){return ae(this.options.tpl_check,{label:an(ao),name:ao,checked:ap?'checked="checked"':""})},_check_event:function(ap){var ao=this;m(ap.firstChild,"click",function(aq){ao._change(this.name,this.checked)})},check_tag:function(aq,au){var ap=this;if(T(aq)){ab(aq,function(av,aw){ap.check_tag(av,aw)});return}var at=ap.$,ao=at[aq];if(ao){ao.firstChild.checked=au;return}var ar=at[aq]=G(ap._check_tpl(aq,au));ap._check_event(ar);at.ul.appendChild(ar)},_change:function(ao,ap){this.trigger("change",[ao,ap])},destroy:function(){}});K("buddy",{template:'<div id="webim-buddy" class="webim-buddy">                        <div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>                        <div class="webim-buddy-content">                                <div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>                                <ul id=":ul"></ul>                        </div>                  </div>',tpl_group:'<li><h4 class="ui-state-default"><%=title%>(<%=count%>)</h4><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=name%></strong><span><%=status%></span></a></li>'},{_init:function(){var ao=this;ao.groups={};ao.li={};ao.li_group={};ao._count=0},_initEvents:function(){var ap=this,at=ap.$,ar=at.search,ao=at.searchInput,au=an("search buddy"),aq="ui-state-active";m(ar.firstChild,"click",function(){ao.focus()});ao.value=au;m(ao,"focus",function(){A(ar,aq);if(this.value==au){this.value=""}});m(ao,"blur",function(){u(ar,aq);if(this.value==""){this.value=au}});m(ao,"keyup",function(){var av=ap.li,aw=this.value;ab(ap.li,function(ay,ax){if(aw&&(ax.text||ax.innerHTML.replace(/<[^>]*>/g,"")).indexOf(aw)==-1){ad(ax)}else{Q(ax)}})})},_titleCount:function(){var ap=this,ao=ap._count,at=ap.window,ar=ap.$.empty,aq=ap.element;at&&at.title(an("chat")+"("+(ao?ao:"0")+")");if(!ao){Q(ar)}else{ad(ar)}if(ao>8){ap.scroll(true)}else{ap.scroll(false)}},scroll:function(ao){h(this.element,"webim-buddy-scroll",ao)},_time:null,_titleBuddyOnline:function(ap){var ao=this,aq=ao.window;if(!ap){ap=""}if(ao._time){clearTimeout(ao._time)}ao._time=setTimeout(function(){ao._titleCount()},5000)},_title:function(ao){var ap=this.window;if(ap){ap.title(an("chat")+"["+an(ao)+"]")}},notice:function(aq,ap){var ao=this;switch(aq){case"buddyOnline":ao._titleBuddyOnline(ap);break;case"count":ao._count=ap;ao._titleCount();break;default:ao._title(aq)}},online:function(){var ao=this,ap=ao.$,aq=ao.window;ao.notice("connect");Q(ap.empty);Q(ap.offline);Q(aq.element)},offline:function(){var ao=this,ap=ao.$,aq=ao.window;ao.notice("offline");ad(ap.offline);ad(ap.empty);ao.scroll(false);ao.removeAll();ad(aq.element)},_updateInfo:function(ao,ap){ao=ao.firstChild;ao.setAttribute("href",ap.url);ao=ao.firstChild;ao.setAttribute("defaultsrc",ap.default_pic_url?ap.default_pic_url:"");ao.setAttribute("src",ap.pic_url);ao=ao.nextSibling;ao.innerHTML=ap.name;ao=ao.nextSibling;ao.innerHTML=ap.status;return ao},_addOne:function(ar,au){var aA=this,ay=aA.li,ao=ar.id,av=aA.$.ul;if(!ay[ao]){if(!ar.default_pic_url){ar.default_pic_url=""}var ap=ay[ao]=G(ae(aA.options.tpl_li,ar));var aw=ap.firstChild;m(aw,"click",function(aB){N(aB);aA.trigger("select",[ar]);this.blur()});var aq=aA.groups,at=an(ar.group||"friend"),ax=aq[at];if(!ax){var az=G(ae(aA.options.tpl_group));ad(az);if(at==an("stranger")){au=true}if(au){av.appendChild(az)}else{av.insertBefore(az,av.firstChild)}ax={name:at,el:az,count:0,title:az.firstChild,li:az.lastChild};aA.groups[at]=ax}if(ax.count==0){Q(ax.el)}aA.li_group[ao]=ax;ax.li.appendChild(ap);ax.count++;ax.title.innerHTML=at+"("+ax.count+")"}},_updateOne:function(aq){var ap=this,ao=ap.li,ar=aq.id;ao[ar]&&ap._updateInfo(ao[ar],aq)},update:function(ap){ap=t(ap);for(var ao=0;ao<ap.length;ao++){this._updateOne(ap[ao])}},add:function(aq,ao){aq=t(aq);for(var ap=0;ap<aq.length;ap++){this._addOne(aq[ap],ao)}},removeAll:function(){var aq=[],ao=this.li;for(var ap in ao){aq.push(ap)}this.remove(aq)},remove:function(ar){var av,aq,ao=this.li,au,at=this.li_group;ar=R(ar);for(var ap=0;ap<ar.length;ap++){av=ar[ap];aq=ao[av];if(aq){au=at[av];if(au){au.count--;if(au.count==0){ad(au.el)}au.title.innerHTML=au.name+"("+au.count+")"}D(aq);delete (ao[av])}}},select:function(aq){var ao=this,ap=ao.li[aq];ap&&ap.firstChild.click();return ap},destroy:function(){}});K("notification",{template:'<div id="webim-notification" class="webim-notification">                        <ul id=":ul"><%=list%></ul>                        <div id=":empty" class="webim-notification-empty"><%=empty notification%></div>                  </div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var ao=this,aq=ao.element,ap=ao.options;var ar=ap.window;ap.data&&ap.data.length&&ad(ao.$.empty)},template:function(){var ap=this,ao=[],aq=ap.options.data;aq&&ab(aq,function(ar,at){ao.push(ap._li_tpl(at))});return ae(ap.options.template,{list:ao.join("")})},_li_tpl:function(ao){return ae(this.options.tpl_li,{text:text,link:link,target:isExtlink?"_blank":""})},_fitUI:function(){var ao=this.element;if(ao.clientHeight>300){ao.style.height=300+"px"}},add:function(aq){var ao=this;if(B(aq)){ab(aq,function(ar,at){ao.add(at)});return}var ap=ao.$;ad(ap.empty);ap.ul.appendChild(G(ao._li_tpl(aq)))},destroy:function(){}});K("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){var ao=this,aq=ao.element,ap=ao.options;aj.call(ao,"init",[null,ao.ui()])},clear:function(){var ao=this;ao.$.content.innerHTML="";ao.trigger("clear")},add:function(at){at=t(at);var aq=this,ao=at.length,ap=[];if(!ao){return}for(var ar=0;ar<ao;ar++){var au=at[ar];ap.push(aq._renderMsg(au))}aq.$.content.innerHTML+=ap.join("");aq.trigger("update")},_renderMsg:function(ap){var aD=this;ap=q({},ap);aj.call(aD,"render",[null,aD.ui({msg:ap})]);var ax=ap.from,ay=ap.to,at=ap.timestamp,ar=ap.body,aA=true,az=aD._lastLogItem,aC=[],aq=aD.options.info,au=aD.options.user;var av=ax==au.id;var aw=!av&&au.id!=ay;var ao=aw?ap.nick:av?au.name:(aq.name?'<a href="'+aq.url+'">'+aq.name+"</a>":aq.id);if(az&&az.to==ay&&az.from==ax&&at-az.timestamp<60000){aA=false}if(aA){aD._lastLogItem=ap;var aB=(new ag(at));aC.push('<h4><span class="webim-gray">');aC.push(aB.getDay(true));aC.push(" ");aC.push(aB.getTime());aC.push("</span>");aC.push(ao);aC.push("</h4>")}aC.push("<p>");aC.push(ar);aC.push("</p>");return aC.join("")},_renderDateBreak:function(au){var aq=this,at=aq._lastLogItem,ao=new Date(),ar=new Date(),ap=[];ao.setTime(au);at&&ar.setTime(at.timestamp);if(!at||ao.getDate()!=ar.getDate()||ao.getMonth()!=ar.getMonth()){ap.push("<h5>");ap.push((new ag(au)).getDay(true));ap.push("</h5>")}return ap.join("")},ui:function(ap){var ao=this;return q({element:ao.element,$:ao.$},ap)},plugins:{}});var O=(function(){var ao;function ap(at,ar,au){return'<a href="'+(ar=="www."?("http://"+at):at)+'"'+ao+">"+at+"</a>"}function aq(ar,at){ao+=" "+ar+'="'+at+'"'}return function(at,ar){ao="";ar&&T(ar)&&ab(ar,aq);return at.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,ap)}})();F.history.defaults.parseMsg=true;aj.add("history","parseMsg",{render:function(ap,ao){var aq=ao.msg.body;aq=x(aq);aq=O(aq,{target:"_blank"});ao.msg.body=aq}});F.history.defaults.emot=true;aj.add("history","emot",{render:function(ap,ao){ao.msg.body=F.emot.parse(ao.msg.body)}});K("menu",{template:'<div id="webim-menu" class="webim-menu">                        <ul id=":ul"><%=list%></ul>                        <div id=":empty" class="webim-menu-empty"><%=empty menu%></div>                  </div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var ao=this,aq=ao.element,ap=ao.options;var ar=ap.window;ap.data&&ap.data.length&&ad(ao.$.empty)},template:function(){var ap=this,ao=[],aq=ap.options.data;aq&&ab(aq,function(ar,at){ao.push(ap._li_tpl(at))});return ae(ap.options.template,{list:ao.join("")})},_li_tpl:function(ao){return ae(this.options.tpl_li,{title:an(ao.title),icon:ao.icon,link:ao.link,target:ao.isExtlink?"_blank":""})},_fitUI:function(){var ao=this.element;if(ao.clientHeight>300){ao.style.height=300+"px"}},add:function(aq){var ao=this;if(B(aq)){ab(aq,function(ar,at){ao.add(at)});return}var ap=ao.$;ad(ap.empty);ap.ul.appendChild(G(ao._li_tpl(aq)))},destroy:function(){}});function af(ao){j.selection&&(this.caretPos=j.selection.createRange())}K("chat",{template:'<div class="webim-chat">                                                 <div id=":header" class="webim-chat-header ui-widget-subheader">                                                          <div id=":user" class="webim-user">                                                                 <a id=":userPic" class="webim-user-pic" href="#id"><img width="50" height="50" src="about:blank" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;"></a>                                                                 <span id=":userStatus" title="" class="webim-user-status">Hello</span>                                                         </div>                                                 </div>                                                                                                                                         <div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},{_init:function(){var ao=this,aq=ao.element,ap=ao.options,at=ao.window=ap.window;var ar=ao.history=new F.history(null,{user:ap.user,info:ap.info});ao.$.content.insertBefore(ar.element,ao.$.content.firstChild);if(at){at.html(aq);ao._bindWindow()}ao.update(ap.info);ar.add(ap.history);aj.call(ao,"init",[null,ao.ui()]);ao._adjustContent()},update:function(ar){var ao=this;if(ar){ao.option("info",ar);ao.history.option("info",ar);ao._updateInfo(ar)}var aq=ao.options.user.presence=="online";var ap=ao.options.info.presence=="online";if(!aq){ao.notice(an("user offline notice"))}else{if(!ap){ao.notice(an("buddy offline notice",{name:ao.options.info.name}))}else{ao.notice("")}}aj.call(ao,"update",[null,ao.ui()])},focus:function(){var ao=this.$.input;V.setTimeout(function(){ao.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(at,ap){var ao=this,aq=ao.$.notice,ar=ao._noticeTime;if(ar){clearTimeout(ar)}if(!at){ao._noticeTxt=null;ad(aq);return}if(ap){aq.innerHTML=at;Q(aq);setTimeout(function(){if(ao._noticeTxt){aq.innerHTML=ao._noticeTxt}else{ad(aq,500)}},ap)}else{ao._noticeTxt=at;aq.innerHTML=at;Q(aq)}},_adjustContent:function(){var ao=this.$.content;ao.scrollTop=ao.scrollHeight},_fitUI:function(ar){var ao=this,aq=ao.window,ap=ao.$;ao._adjustContent()},_bindWindow:function(){var ao=this,ap=ao.window;ap.bind("displayStateChange",function(aq){if(aq!="minimize"){V.setTimeout(function(){ao.$.input.focus()},0);ao._adjustContent()}})},_inputAutoHeight:function(){var ap=this.$.input,aq=ap[0].scrollTop;if(aq>0){var ao=ap.height();if(ao>32&&ao<100){ap.height(ao+aq)}}},_sendMsg:function(at){var ao=this,ap=ao.options,aq=ap.info;var ar={type:ap.msgType,to:aq.id,from:ap.user.id,stype:"",offline:aq.presence=="online"?0:1,body:at,timestamp:(new Date()).getTime()};aj.call(ao,"send",[null,ao.ui({msg:ar})]);ao.trigger("sendMsg",ar)},_inputkeypress:function(ar){var ao=this,aq=ao.$;if(ar.keyCode==13){if(ar.ctrlKey){ao.insert("\n",true);return true}else{var ap=c(ar),at=ap.value;if(d(at)){ao._sendMsg(at);ap.value="";N(ar)}}}else{ao._typing()}},_onFocusInput:function(aq){var ao=this,ap=c(aq);var ar=V.getSelection?V.getSelection().toString():(j.selection?j.selection.createRange().text:"");if(!ar){V.setTimeout(function(){ao.$.input.focus()},0)}},_initEvents:function(){var aq=this,ar=aq.options,at=aq.$,au=an("input notice"),ao="webim-gray",ap=at.input;aq.history.bind("update",function(){aq._adjustContent()}).bind("clear",function(){aq.notice(an("clear history notice"),3000)});m(ap,"keyup",function(){af.call(this)});m(ap,"click",af);m(ap,"select",af);m(ap,"focus",function(){u(this,ao);if(this.value==au){this.value=""}});m(ap,"blur",function(){if(this.value==""){A(this,ao);this.value=au}});m(ap,"keypress",function(av){aq._inputkeypress(av)});m(at.content,"click",function(av){aq._onFocusInput(av)})},_updateInfo:function(aq){var ao=this,ap=ao.$;ap.userPic.setAttribute("href",aq.url);ap.userPic.firstChild.setAttribute("defaultsrc",aq.default_pic_url?aq.default_pic_url:"");ap.userPic.firstChild.setAttribute("src",aq.pic_url);ap.userStatus.innerHTML=aq.status;ao.window.title(aq.name)},insert:function(ax,ap){var az=this,aw=az.$.input;aw.focus();if(!ap){aw.value=ax;return}if(!ax){ax=""}if(aw.setSelectionRange){var aq=aw.value,ay=aw.selectionStart,ao=aw.selectionEnd,au=aq.substring(0,ay),at=aq.substring(ao),av=ax.length;aw.value=au+ax+at;aw.setSelectionRange(ay+av,ay+av)}else{if(j.selection){var ar=aw.caretPos;if(ar){ar.text=ax;ar.collapse();ar.select()}else{aw.value+=ax}}else{aw.value+=ax}}},_statusText:"",sendStatus:function(ao){var ap=this;if(!ao||ao==ap._statusText){return}ap._statusText=ao;ap.trigger("sendStatus",{to:ap.options.info.id,show:ao})},_checkST:false,_typing:function(){var ao=this;ao.sendStatus("typing");if(ao._checkST){clearTimeout(ao._checkST)}ao._checkST=V.setTimeout(function(){ao.sendStatus("clear")},6000)},_setST:null,status:function(at){at=at||"clear";var ap=this,ar=ap.$.status,aq=ap.options.info.name,ao="";ao=at=="clear"?"":aq+an(at);ar.innerHTML=ao;ap._adjustContent();if(ap._setST){clearTimeout(ap._setST)}if(ao!=""){ap._setST=V.setTimeout(function(){ar.innerHTML=""},10000)}},destroy:function(){this.window.close()},ui:function(ap){var ao=this;return q({self:ao,$:ao.$,history:ao.history},ap)},plugins:{}});F.chat.defaults.emot=true;aj.add("chat","emot",{init:function(at,ar){var ao=ar.self;var aq=new F.emot();aq.bind("select",function(au){ao.focus();ao.insert(au,true)});var ap=G(ae('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));m(ap,"click",function(au){N(au);aq.toggle()});ar.$.toolContent.appendChild(aq.element);ar.$.tools.appendChild(ap)},send:function(ap,ao){}});F.chat.defaults.clearHistory=true;aj.add("chat","clearHistory",{init:function(ar,aq){var ao=aq.self;var ap=G(ae('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));m(ap,"click",function(at){N(at);ao.trigger("clearHistory",[ao.options.info])});aq.$.tools.appendChild(ap)}});F.chat.defaults.block=true;aj.add("chat","block",{init:function(au,at){var ap=at.self;var ar=ap.options.info.blocked,aq=ap.options.info.name,av=G('<a href="#chat-block" style="display:'+(ar?"none":"")+'" title="'+an("block group",{name:aq})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),ao=G('<a href="#chat-block" style="display:'+(ar?"":"none")+'" title="'+an("unblock group",{name:aq})+'"><em class="webim-icon webim-icon-block"></em></a>');m(av,"click",function(aw){N(aw);ad(av);Q(ao);ap.trigger("block",[ap.options.info])});m(ao,"click",function(aw){N(aw);ad(ao);Q(av);ap.trigger("unblock",[ap.options.info])});at.$.tools.appendChild(av);at.$.tools.appendChild(ao)}});F.chat.defaults.member=true;q(F.chat.prototype,{addMember:function(av,ar,aq){var ap=this,at=ap.$.member,ao=ap.memberLi;if(ao[av]){return}var au=G('<li><a class="'+(aq?"ui-state-disabled":"")+'" href="'+av+'">'+ar+"</a></li>");m(au.firstChild,"click",function(aw){N(aw);aq||ap.trigger("select",[{id:av,name:ar}])});ao[av]=au;ap.$.member.appendChild(au)},removeMember:function(aq){var ao=this,ap=ao.memberLi[aq];if(ap){ao.$.member.removeChild(ap);delete ao.memberLi[aq]}}});aj.add("chat","member",{init:function(ar,aq){var ao=aq.self,ap=aq.$;ao.memberLi={};var at=G('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><ul></ul></div>');ap.member=at.lastChild;ap.content.parentNode.insertBefore(at,ap.content)}});e("room",{init:function(){var av=this,ao=av.im,aw=ao.room,at=ao.setting,aq=ao.data.user,au=av.layout;var ap=av.room=new webim.ui.room(null).bind("select",function(ax){av.addChat(ax.id,{type:"room"});av.layout.focusChat(ax.id)});au.addApp(ap,{title:an("room"),icon:"room",sticky:false,isMinimize:true},"notification");av.window&&av.window.title(an("room"));aw.bind("join",function(ax){ar(ax)}).bind("leave",function(ax){}).bind("block",function(ay,ax){at.set("block_list",ax);ar(aw.get(ay));aw.leave(ay,aq)}).bind("unblock",function(ay,ax){at.set("block_list",ax);ar(aw.get(ay));aw.join(ay,aq)}).bind("addMember",function(ax,ay){var az=au.chat(ax);az&&az.addMember(ay.id,ay.name,ay.id==ao.data.user.id);ar(aw.get(ax))}).bind("removeMember",function(ax,ay){var az=au.chat(ax);az&&az.removeMember(ay.id,ay.name);ar(aw.get(ax))});function ar(ay){var ax=ay.name;ay=q({},ay,{group:"group",name:ax+"("+(parseInt(ay.count)+"/"+parseInt(ay.all_count))+")"});au.updateChat(ay);ay.blocked&&(ay.name=ax+"("+an("blocked")+")");ap.li[ay.id]?ap.update(ay):ap.add(ay)}},ready:function(){},go:function(){},stop:function(){}});K("room",{template:'<div id="webim-room" class="webim-room">                        <div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>                        <div class="webim-room-content">                                <div id=":empty" class="webim-room-empty"><%=empty room%></div>                                <ul id=":ul"></ul>                        </div>                  </div>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=name%></strong><span><%=status%></span></a></li>'},{_init:function(){var ao=this;ao.li={};ao._count=0},_initEvents:function(){var ap=this,at=ap.$,ar=at.search,ao=at.searchInput,au=an("search room"),aq="ui-state-active";m(ar.firstChild,"click",function(){ao.focus()});ao.value=au;m(ao,"focus",function(){A(ar,aq);if(this.value==au){this.value=""}});m(ao,"blur",function(){u(ar,aq);if(this.value==""){this.value=au}});m(ao,"keyup",function(){var av=ap.li,aw=this.value;ab(ap.li,function(ay,ax){if(aw&&(ax.text||ax.innerHTML.replace(/<[^>]*>/g,"")).indexOf(aw)==-1){ad(ax)}else{Q(ax)}})})},_titleCount:function(){var ap=this,ao=ap._count,at=ap.window,ar=ap.$.empty,aq=ap.element;at&&at.title(an("chat")+"("+(ao?ao:"0")+")");if(!ao){Q(ar)}else{ad(ar)}if(ao>8){ap.scroll(true)}else{ap.scroll(false)}},scroll:function(ao){h(this.element,"webim-room-scroll",ao)},_updateInfo:function(ao,ap){ao=ao.firstChild;ao.setAttribute("href",ap.url);ao=ao.firstChild;ao.setAttribute("defaultsrc",ap.default_pic_url?ap.default_pic_url:"");ao.setAttribute("src",ap.pic_url);ao=ao.nextSibling;ao.innerHTML=ap.name;ao=ao.nextSibling;ao.innerHTML=ap.status;return ao},_addOne:function(av,aq){var ar=this,ao=ar.li,aw=av.id,at=ar.$.ul;if(!ao[aw]){if(!av.default_pic_url){av.default_pic_url=""}if(av.url==r||av.url==""){av.url=location.href}var au=ao[aw]=G(ae(ar.options.tpl_li,av));var ap=au.firstChild;m(ap,"click",function(ax){N(ax);ar.trigger("select",[av]);this.blur()});at.appendChild(au)}},_updateOne:function(aq){var ap=this,ao=ap.li,ar=aq.id;ao[ar]&&ap._updateInfo(ao[ar],aq)},update:function(ap){ap=t(ap);for(var ao=0;ao<ap.length;ao++){this._updateOne(ap[ao])}},add:function(ap){ap=t(ap);for(var ao=0;ao<ap.length;ao++){this._addOne(ap[ao])}},removeAll:function(){var aq=[],ao=this.li;for(var ap in ao){aq.push(ap)}this.remove(aq)},remove:function(ar){var av,aq,ao=this.li,au,at=this.li_group;ar=R(ar);for(var ap=0;ap<ar.length;ap++){av=ar[ap];aq=ao[av];if(aq){au=at[av];if(au){au.count--;if(au.count==0){ad(au.el)}au.title.innerHTML=au.name+"("+au.count+")"}D(aq);delete (ao[av])}}},select:function(aq){var ao=this,ap=ao.li[aq];ap&&ap.firstChild.click();return ap},destroy:function(){}});e("hotpost",{init:function(){var ao=new webim.hotpost();var ap=new F.hotpost();this.layout.addApp(ap,{title:an("hotpost"),icon:"hotpost",sticky:false,onlyIcon:true,isMinimize:true},"setting");ao.bind("data",function(aq){ap.$.ul.innerHTML="";ap.add(aq)});setTimeout(function(){ao.load()},2000)}});K("hotpost",{template:'<div id="webim-hotpost" class="webim-hotpost">                        <ul id=":ul"><%=list%></ul>                        <div id=":empty" class="webim-hotpost-empty"><%=empty hotpost%></div>                  </div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var ao=this,aq=ao.element,ap=ao.options;var ar=ap.window;ap.data&&ap.data.length&&ad(ao.$.empty)},template:function(){var ap=this,ao=[],aq=ap.options.data;aq&&ab(aq,function(ar,at){ao.push(ap._li_tpl(at))});return ae(ap.options.template,{list:ao.join("")})},_li_tpl:function(ao){return ae(this.options.tpl_li,{text:ao.text,link:ao.link,target:""})},_fitUI:function(){var ao=this.element;if(ao.clientHeight>300){ao.style.height=300+"px"}},add:function(aq){var ao=this;if(B(aq)){ab(aq,function(ar,at){ao.add(at)});return}var ap=ao.$;ad(ap.empty);ap.ul.appendChild(G(ao._li_tpl(aq)))},destroy:function(){}})})(window,document);