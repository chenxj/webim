/*
 * Webim v1.0.0pre
 * http://www.nextim.cn/
 *
 * Copyright (c) 2009 Hidden
 *
 * Date: 
 * Revision: 
 */
(function(G,d,l){function H(){return(new Date).getTime()}function c(O){var P=location;var Q=new RegExp("(^|&|\\?)"+O+"=(\\d*)(&|$)","i");if(Q.test(P)){return RegExp.$1}return""}var w=Object.prototype.toString;function p(O){return w.call(O)==="[object Function]"}function t(O){return w.call(O)==="[object Array]"}function C(O){return O&&w.call(O)==="[object Object]"}function a(O){return(O||"").replace(/^\s+|\s+$/g,"")}function N(O,R){var Q=false;if(C(R)){O=O||{};for(var P in R){var S=R[P];if(O[P]!=S){Q=Q||{};Q[P]=S}}}return Q}function o(Q){var O=[];if(Q!=null){var P=Q.length;if(P==null||typeof Q==="string"||p(Q)||Q.setInterval){O[0]=Q}else{while(P){O[--P]=Q[P]}}}return O}function j(){var T=arguments[0]||{},R=1,S=arguments.length,O=false,Q;if(typeof T==="boolean"){O=T;T=arguments[1]||{};R=2}if(typeof T!=="object"&&!p(T)){T={}}for(;R<S;R++){if((Q=arguments[R])!=null){for(var P in Q){var U=T[P],V=Q[P];if(T===V){continue}if(O&&V&&typeof V==="object"&&!V.nodeType){T[P]=j(O,U||(V.length!=null?[]:{}),V)}else{if(V!==l){T[P]=V}}}}}return T}function I(R,V,Q){var P,S=0,T=R.length,O=T===l||p(R);if(Q){if(O){for(P in R){if(V.apply(R[P],Q)===false){break}}}else{for(;S<T;){if(V.apply(R[S++],Q)===false){break}}}}else{if(O){for(P in R){if(V.call(R[P],P,R[P])===false){break}}}else{for(var U=R[0];S<T&&V.call(U,S,U)!==false;U=R[++S]){}}}return R}function J(Q,R){for(var O=0,P=R.length;O<P;O++){if(R[O]===Q){return O}}return -1}function L(P,T,O){var Q=[];for(var R=0,S=P.length;R<S;R++){if(!O!==!T(P[R],R)){Q.push(P[R])}}return Q}function u(O,T){var P=[],S;for(var Q=0,R=O.length;Q<R;Q++){S=T(O[Q],Q);if(S!=null){P[P.length]=S}}return P.concat.apply([],P)}var r={option:function(Q,R){var P=Q,O=this;O.options=O.options||{};if(typeof Q=="string"){if(R===l){return O.options[Q]}P={};P[Q]=R}j(O.options,P);return O},bind:function(Q,P){var O=this,R=O._events=O._events||{};if(p(P)){R[Q]=R[Q]||[];R[Q].push(P)}return this},trigger:function(T,Q){var P=this,U=P._events=P._events||{},S=U[T];if(!S){return this}Q=t(Q)?Q:o(Q);for(var R=0,O=S.length;R<O;R++){S[R].apply(this,Q)}return this},unbind:function(S,R){var P=this,T=P._events=P._events||{};if(!T[S]){return this}if(p(R)){var O=T[S];for(var Q=O.length;Q--;Q){if(O[Q]===R||O[Q]===R._proxy){O.splice(Q,1)}}}else{delete T[S]}return this},one:function(R,Q){if(!p(Q)){return this}var O=this,P=Q._proxy=fun._proxy||function(){O.unbind(R,P);return Q.apply(this,arguments)};O.bind(R,P)}};function g(O){var Q=[];if(typeof O=="object"){for(var P in O){Q[Q.length]=encodeURIComponent(P)+"="+encodeURIComponent(O[P])}return Q.join("&").replace(M,"+")}return O}var f=H(),F=/\?/,D=/(\?|&)_=.*?(&|$)/,M=/%20/g,i={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return G.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},B={},n={};function K(P,R,O,Q){if(P.error){P.error.call(P.context||G,R,O,Q)}}function q(P){try{return !P.status&&location.protocol==="file:"||(P.status>=200&&P.status<300)||P.status===304||P.status===1223||P.status===0}catch(O){}return false}function m(R,P){var Q=R.getResponseHeader("Last-Modified"),O=R.getResponseHeader("Etag");if(Q){B[P]=Q}if(O){n[P]=O}return R.status===304||R.status===0}function s(T,R,Q){var P=T.getResponseHeader("content-type"),O=R==="xml"||!R&&P&&P.indexOf("xml")>=0,S=O?T.responseXML:T.responseText;if(O&&S.documentElement.nodeName==="parsererror"){throw"parsererror"}if(Q&&Q.dataFilter){S=Q.dataFilter(S,R)}if(typeof S==="string"){if(R==="json"){if(typeof h==="object"&&h.parse){S=h.parse(S)}else{S=(new Function("return "+S))()}}}return S}function E(O){j(i,O)}function y(ab){ab=j(true,ab,j(true,{},i,ab));var R,S,Q=ab.context||G,W=ab.type.toUpperCase();if(ab.data&&ab.processData&&typeof ab.data!=="string"){ab.data=g(ab.data)}if(ab.cache===false&&W==="GET"){var V=H();var U=ab.url.replace(D,"$1_="+V+"$2");ab.url=U+((U===ab.url)?(F.test(ab.url)?"&":"?")+"_="+V:"")}if(ab.data&&W==="GET"){ab.url+=(F.test(ab.url)?"&":"?")+ab.data}var P=false;var aa=ab.xhr();if(ab.username){aa.open(W,ab.url,ab.async,ab.username,ab.password)}else{aa.open(W,ab.url,ab.async)}try{if(ab.data){aa.setRequestHeader("Content-Type",ab.contentType)}if(ab.ifModified){if(B[ab.url]){aa.setRequestHeader("If-Modified-Since",B[ab.url])}if(n[ab.url]){aa.setRequestHeader("If-None-Match",n[ab.url])}}aa.setRequestHeader("X-Requested-With","XMLHttpRequest");aa.setRequestHeader("Accept",ab.dataType&&ab.accepts[ab.dataType]?ab.accepts[ab.dataType]+", */*":ab.accepts._default)}catch(T){}if(ab.beforeSend&&ab.beforeSend.call(Q,aa,ab)===false){aa.abort();return false}var Y=function(ac){if(!aa||aa.readyState===0){if(X){clearInterval(X);X=null}}else{if(!P&&aa&&(aa.readyState===4||ac==="timeout")){P=true;if(X){clearInterval(X);X=null}R=ac==="timeout"?"timeout":!q(aa)?"error":ab.ifModified&&m(aa,ab.url)?"notmodified":"success";if(R==="success"){try{S=s(aa,ab.dataType,ab)}catch(ad){R="parsererror"}}if(R==="success"||R==="notmodified"){Z()}else{K(ab,aa,R)}O();if(ac){aa.abort()}if(ab.async){aa=null}}}};if(ab.async){var X=setInterval(Y,13);if(ab.timeout>0){setTimeout(function(){if(aa&&!P){Y("timeout")}},ab.timeout)}}try{aa.send(W==="POST"||W==="PUT"?ab.data:null)}catch(T){K(ab,aa,null,T)}if(!ab.async){Y()}function Z(){if(ab.success){ab.success.call(Q,S,R)}}function O(){if(ab.complete){ab.complete.call(Q,aa,R)}}return aa}function x(){}function k(W){W=j({},W);var Q=""+g(W.data),O=W.context||G,U="jsonp"+f++,S=d.getElementsByTagName("head")[0]||d.documentElement,T=d.createElement("script");Q=(Q?(Q+"&"):"")+(W.jsonp||"callback")+"="+U;W.url+=(F.test(W.url)?"&":"?")+Q;T.src=W.url;if(W.scriptCharset){T.charset=W.scriptCharset}var P=false;G[U]=function(X){W.success&&W.success.call(O,X,"success");V()};T.onload=T.onreadystatechange=function(){if(!P&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){R("error");V()}};if(W.timeout>0){setTimeout(function(){if(!P){R("timeout");V();G[U]=x}},W.timeout)}S.insertBefore(T,S.firstChild);return l;function V(){P=true;G[U]=l;try{delete G[U]}catch(X){}T.onload=T.onreadystatechange=null;if(S&&T.parentNode){S.removeChild(T)}}function R(X){W.error&&W.error.call(O,X)}}var h=(function(){var P={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function Q(R){return P[R]||"\\u00"+Math.floor(R.charCodeAt()/16).toString(16)+(R.charCodeAt()%16).toString(16)}function O(W){switch(Object.prototype.toString.call(W)){case"[object String]":return'"'+W.replace(/[\x00-\x1f\\"]/g,Q)+'"';case"[object Array]":var S=[],R=W.length;for(var V=0;V<R;V++){S.push(O(W[V]))}return"["+S.join(",")+"]";case"[object Object]":var S=[];for(var U in W){var T=O(W[U]);if(T){S.push(O(U)+":"+T)}}return"{"+S+"}";case"[object Number]":case"[object Boolean]":return String(W);case false:return"null"}return null}return{encode:O,decode:function(R){if(!R||!R.length){return null}return(new Function("return "+R))()}}})();function z(Q,P){var O=this;O._setting();O.options={jsonp:false,host:null,port:null,server:null,ticket:null,domain:null,url:{send:null}};j(O.options,P)}j(z.prototype,r,{_setting:function(){var O=this;O.connected=false;O._connecting=false;O._onPolling=false;O._pollTimer=null;O._pollingTimes=0;O._failTimes=0},connect:function(Q){var O=this;j(O.options,Q);if(O._connecting){return O}O._connecting=true;var Q=O.options,P=false,R=[];I(["server","ticket","domain"],function(T,S){if(!Q[S]){R.push(S);R.push(" required.");P=true}});if(P){O._onError("error",R.join(" "));return O}if(!O._onPolling){G.setTimeout(function(){O._startPolling()},300)}return O},close:function(){var O=this;if(O._pollTimer){clearTimeout(O._pollTimer)}O._setting();return O},_onConnect:function(){var O=this;O.connected=true;O.trigger("connect","success")},_onClose:function(O){var P=this;P._setting();P.trigger("close",[O])},_onData:function(P){var O=this;O.trigger("data",P)},_onError:function(P){var O=this;O._setting();O.trigger("error",P)},_startPolling:function(){var O=this,Q=O.options;O._onPolling=true;O._pollingTimes++;var P=Q.server+"/packets";var R={domain:Q.domain,ticket:Q.ticket};var S={url:P,data:R,timeout:40000,cache:false,context:O,success:O._onPollSuccess,error:O._onPollError};if(Q.jsonp){j(S,{timeout:40000,dataType:"jsonp",jsonp:"callback"});k(S)}else{y(S)}},_onPollSuccess:function(P){var O=this;O._onPolling=false;if(!O._connecting){return}if(O._pollingTimes==1){O._onConnect()}O._onData(P);O._failTimes=0;O._pollTimer=G.setTimeout(function(){O._startPolling()},200)},_onPollError:function(O){var P=this;P._onPolling=false;if(!P._connecting){return}P._failTimes++;if(P._pollingTimes==1){P._onError("can not connect.")}else{if(P._failTimes>1){P._onClose(O)}else{P._pollTimer=G.setTimeout(function(){P._startPolling()},200)}}}});function v(P,W,Z){if(typeof W!="undefined"){Z=Z||{};if(W===null){W="";Z=j({},Z);Z.expires=-1}var S="";if(Z.expires&&(typeof Z.expires=="number"||Z.expires.toUTCString)){var T;if(typeof Z.expires=="number"){T=new Date();T.setTime(T.getTime()+(Z.expires*24*60*60*1000))}else{T=Z.expires}S="; expires="+T.toUTCString()}var Y=Z.path?"; path="+(Z.path):"";var U=Z.domain?"; domain="+(Z.domain):"";var O=Z.secure?"; secure":"";d.cookie=[P,"=",encodeURIComponent(W),S,Y,U,O].join("")}else{var R=null;if(d.cookie&&d.cookie!=""){var X=d.cookie.split(";");for(var V=0;V<X.length;V++){var Q=a(X[V]);if(Q.substring(0,P.length+1)==(P+"=")){R=decodeURIComponent(Q.substring(P.length+1));break}}}return R}}function e(Q,P){var O=this;O.options=j({},e.defaults,P);this._init(Q,P)}j(e.prototype,r,{_init:function(){var O=this;O.data={user:{}};O.status=new e.status();O.setting=new e.setting();O.buddy=new e.buddy();O.room=new e.room();O.history=new e.history();O.connection=new z(null,{jsonp:true});O._initEvents()},ready:function(){var O=this;O._unloadFun=G.onbeforeunload;G.onbeforeunload=function(){};O.trigger("ready")},go:function(){var P=this,S=P.data,U=P.history,Q=P.buddy,T=P.room;P.connection.connect(S.connection);U.option("userInfo",S.user);U.init(S.histories);Q.handle(S.buddies);Q.online(S.buddy_online_ids,true);var O=P.setting.get("block_list"),R=S.rooms;t(O)&&R&&I(O,function(X,W){R[W]&&(R[W].blocked=true)});T.handle(R);T.options.ticket=S.connection.ticket;var V=S.new_messages;if(V&&V.length){P.trigger("message",[V])}P.trigger("go",[S])},stop:function(P){var O=this;G.onbeforeunload=O._unloadFun;O.data.user.presence="offline";O.buddy.clear();O.trigger("stop",P)},autoOnline:function(){return !this.status.get("o")},_initEvents:function(){var Q=this,O=Q.status,R=Q.setting,S=Q.history,P=Q.connection;P.bind("connect",function(U,T){}).bind("data",function(T){Q.handle(T)}).bind("error",function(T){Q.stop("connect error")}).bind("close",function(T){Q.stop("disconnect")})},handle:function(P){var O=this;P.messages&&P.messages.length&&O.trigger("message",[P.messages]);P.presences&&P.presences.length&&O.trigger("presence",[P.presences]);P.statuses&&P.statuses.length&&O.trigger("status",[P.statuses])},sendMsg:function(P){var O=this;P.ticket=O.data.connection.ticket;y({type:"post",url:O.options.urls.message,type:"post",cache:false,data:P})},sendStatus:function(P){var O=this;P.ticket=O.data.connection.ticket;y({type:"post",url:O.options.urls.status,type:"post",cache:false,data:P})},setStranger:function(O){this.stranger_ids=A(O)},stranger_ids:[],online:function(){var P=this,O=P.status,Q=[],R=O.get("tabs"),S=O.get("tabIds");O.set("o",false);P.ready();S&&S.length&&R&&I(R,function(U,T){T.t=="buddy"&&Q.push(U)});y({type:"post",dataType:"json",data:{buddy_ids:Q.join(","),stranger_ids:P.stranger_ids.join(","),room_ids:c(P.roomIdendify),timestamp:parseInt(new Date().getTime()/1000)},url:P.options.urls.online,success:function(T){if(!T||!T.user||!T.connection){P.stop("online error")}else{T.user=j(P.data.user,T.user);P.data=T;P.go()}},error:function(T){P.stop("online error")}})},offline:function(){var O=this,P=O.data;O.status.set("o",true);O.connection.close();O.stop("offline");y({type:"post",url:O.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:P.connection.ticket}})},refresh:function(){var O=this,P=O.data;if(!P||!P.connection||!P.connection.ticket){return}y({type:"post",url:O.options.urls.refresh,type:"post",cache:false,data:{ticket:P.connection.ticket}})}});function A(O){return O&&O.split?O.split(","):(t(O)?O:(parseInt(O)?[parseInt(O)]:[]))}function b(P,R,Q){function O(U,T){var S=this;S.data=U;S.options=j({},O.defaults,T);p(S._init)&&S._init()}O.defaults=R;j(O.prototype,r,Q);e[P]=O}G.webim=e;j(e,{version:"1.0.0pre",defaults:{},idsArray:A,now:H,isFunction:p,isArray:t,isObject:C,trim:a,makeArray:o,extend:j,each:I,inArray:J,grep:L,map:u,JSON:h,ajax:y,model:b,objectExtend:r});b("setting",{url:"/webim/setting",data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){var O=this;O.data=j({},O.options.data,O.data)},get:function(O){return this.data[O]},set:function(S,U){var Q=this,R=S;if(!S){return}if(typeof S=="string"){R={};R[S]=U}var P=Q.data,O=N(P,R);if(O){I(O,function(V,W){Q.trigger("update",[V,W])});var T=j({},P,R);Q.data=T;y({type:"post",url:Q.options.url,dataType:"json",cache:false,data:{data:h.encode(T)}})}}});b("status",{key:"_webim"},{_init:function(){var O=this,P=O.data;if(!P){var Q=v(O.options.key);O.data=Q?h.decode(Q):{}}else{O._save(P)}},set:function(R,T){var Q=R,P=this;if(typeof R=="string"){Q={};Q[R]=T}var O=P.data;if(N(O,Q)){var S=j({},O,Q);P._save(S)}},get:function(O){return this.data[O]},clear:function(){this._save({})},_save:function(O){this.data=O;v(this.options.key,h.encode(O),{path:"/",domain:d.domain})}});b("buddy",{url:"/webim/buddy"},{_init:function(){var O=this;O.data=O.data||[];O.dataHash={};O._cacheData={};O.handle(O.data)},clear:function(){var O=this;O.data=[];O.dataHash={};O._cacheData={}},count:function(T){var S=j({},this.dataHash,this._cacheData),R=0,Q;for(var P in S){if(C(T)){Q=true;for(var O in T){if(T[O]!=S[P][O]){Q=false}}if(Q){R++}}else{R++}}return R},get:function(O){return this.dataHash[O]},online:function(P,O){this.changeStatus(P,"online",true,O)},offline:function(O){this.changeStatus(O,"offline",false)},loadDelay:function(){var P=this,O=P._cacheData,Q=[];for(var R in O){Q.push(R)}P.load(Q)},update:function(O){this.load(O)},changeStatus:function(O,X,V,R){O=A(O);var S=O.length;if(S){var aa=this,P=aa._cacheData,U=aa.dataHash,Y=[],Q,W=[],Z;for(var T=0;T<S;T++){Q=O[T];if(U[Q]){Y.push({id:Q,presence:X})}else{Z={id:Q,presence:X};if(!P[Q]||P[Q].presence!=X){W.push(Z)}if(V){P[Q]=Z}else{if(P[Q]){delete P[Q]}}}}aa.handle(Y);if(V&&!R){aa.loadDelay()}else{if(W.length){if(V){aa.trigger(X+"Delay",[W])}else{aa.trigger(X,[W])}}}}},_loadSuccess:function(T){var Q=this.self||this,P=Q._cacheData,O=T.length,S,U;for(var R in T){S=T[R];U=S.id;if(P[U]){j(S,P[U]);delete P[U]}}Q.handle(T)},load:function(Q){Q=A(Q);if(Q.length){var O=this,P=O.options;y({url:P.url,cache:false,dataType:"json",data:{ids:Q.join(",")},context:O,success:O._loadSuccess})}},handle:function(P){var Y=this,S=Y.data,T=Y.dataHash,Q={};P=P||[];var O=P.length,W,U,X;for(var R in P){W=P[R],id=W.id;if(id){if(!T[id]){T[id]={};S.push(T[id])}X=N(T[id],W);if(X){U=X.presence||"update";Q[U]=Q[U]||[];j(T[id],X);Q[U].push(T[id])}}}for(var V in Q){Y.trigger(V,[Q[V]])}}});(function(){b("room",{urls:{join:"/webim/join.php",leave:"/webim/leave.php",member:"/webim/members.php"}},{_init:function(){var O=this;O.data=O.data||[];O.dataHash={}},get:function(O){return this.dataHash[O]},block:function(R){var O=this,Q=O.dataHash[R];if(Q&&!Q.blocked){Q.blocked=true;var P=[];I(O.dataHash,function(T,S){if(S.blocked){P.push(S.id)}});O.trigger("block",[R,P])}},unblock:function(R){var O=this,Q=O.dataHash[R];if(Q&&Q.blocked){Q.blocked=false;var P=[];I(O.dataHash,function(T,S){if(S.blocked){P.push(S.id)}});O.trigger("unblock",[R,P])}},handle:function(S){var P=this,R=P.data,Q=P.dataHash,O={};I(S,function(U,T){var V=T.id;if(V){T.members=T.members||[];T.count=T.count||0;T.all_count=T.all_count||0;if(!Q[V]){Q[V]=T;R.push(T)}else{j(Q[V],T)}P.trigger("join",[Q[V]])}})},addMember:function(R,T){var P=this;if(t(T)){I(T,function(W,V){P.addMember(R,V)});return}var S=P.dataHash[R];if(S){var O=S.members,U;for(var Q=O.length;Q--;Q){if(O[Q].id==T.id){U=O[Q]}}if(!U){T.name=T.nick||T.name;O.push(T);S.members.length;P.trigger("addMember",[R,T])}}},removeMember:function(R,Q){var S=this.dataHash[R];if(S){var O=S.members,T;for(var P=O.length;P--;P){if(O[P].id==Q){T=O[P];O.splice(P,1);S.count--}}T&&self.trigger("removeMember",[R,T])}},initMember:function(P){var O=this.dataHash[P];if(O&&!O.initMember){O.initMember=true;this.loadMember(P)}},loadMember:function(Q){var O=this,P=O.options;y({cache:false,url:P.urls.member,dataType:"json",data:{ticket:P.ticket,id:Q},success:function(R){I(R,function(T,S){O.addMember(T,S)})}})},join:function(R,P){var O=this,Q=O.options;y({cache:false,url:Q.urls.join,dataType:"json",data:{ticket:Q.ticket,id:R,nick:P.name},success:function(S){O.initMember(R);O.handle([S])}})},leave:function(S,P){var O=this,Q=O.options,R=O.dataHash[S];if(R){R.initMember=false;y({cache:false,url:Q.urls.leave,data:{ticket:Q.ticket,id:S,nick:P.name}});O.trigger("leave",[R])}},clear:function(){}})})();b("history",{urls:{load:"",clear:""}},{_init:function(){this.data=this.data||{}},get:function(O){return this.data[O]},handle:function(S){var Y=this,U=Y.data,P={};S=o(S);var R=S.length,X,Q,V=Y.options.userInfo.id;if(!R){return}for(var T=0;T<R;T++){X=S[T];Q=X.to==V?X.from:X.to;if(Q!=l){P[Q]=P[Q]||[];P[Q].push(X)}}var O=[];for(var W in P){var X=P[W];if(U[W]){U[W]=U[W].concat(X);Y._triggerMsg(W,X)}else{O.push(W)}}Y.load(O)},_triggerMsg:function(P,O){this.trigger("data",[P,O])},clear:function(S){S=A(S);var P=this,O=S.length,Q=P.options,T;if(O){for(var R=0;R<O;R++){T=S[R];P.data[T]=[];P.trigger("clear",[T])}y({url:Q.urls.clear,cache:false,dataType:"json",data:{ids:S.join(",")}})}},init:function(R){var P=this.self||this,O;for(var Q in R){O=R[Q];P.data[Q]=O;P._triggerMsg(Q,O)}},load:function(R){R=A(R);if(R.length){var O=this,P=O.options;for(var Q=0;Q<R.length;Q++){O.data[R[Q]]=[]}y({url:P.urls.load,cache:false,dataType:"json",data:{ids:R.join(",")},context:O,success:O.init})}}})})(window,document);