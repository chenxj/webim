function now(){return(new Date).getTime()}function getTid(a){var b=location;var c=new RegExp("(^|&|\\?)"+a+"=(\\d*)(&|$)","i");if(c.test(b)){return RegExp.$1}return""}var _toString=Object.prototype.toString;function isFunction(a){return _toString.call(a)==="[object Function]"}function isArray(a){return _toString.call(a)==="[object Array]"}function isObject(a){return a&&_toString.call(a)==="[object Object]"}function trim(a){return(a||"").replace(/^\s+|\s+$/g,"")}function checkUpdate(a,d){var c=false;if(isObject(d)){a=a||{};for(var b in d){var e=d[b];if(a[b]!=e){c=c||{};c[b]=e}}}return c}function makeArray(c){var a=[];if(c!=null){var b=c.length;if(b==null||typeof c==="string"||isFunction(c)||c.setInterval){a[0]=c}else{while(b){a[--b]=c[b]}}}return a}function extend(){var f=arguments[0]||{},d=1,e=arguments.length,a=false,c;if(typeof f==="boolean"){a=f;f=arguments[1]||{};d=2}if(typeof f!=="object"&&!isFunction(f)){f={}}for(;d<e;d++){if((c=arguments[d])!=null){for(var b in c){var g=f[b],h=c[b];if(f===h){continue}if(a&&h&&typeof h==="object"&&!h.nodeType){f[b]=extend(a,g||(h.length!=null?[]:{}),h)}else{if(h!==undefined){f[b]=h}}}}}return f}function each(d,h,c){var b,e=0,f=d.length,a=f===undefined||isFunction(d);if(c){if(a){for(b in d){if(h.apply(d[b],c)===false){break}}}else{for(;e<f;){if(h.apply(d[e++],c)===false){break}}}}else{if(a){for(b in d){if(h.call(d[b],b,d[b])===false){break}}}else{for(var g=d[0];e<f&&h.call(g,e,g)!==false;g=d[++e]){}}}return d}function inArray(c,d){for(var a=0,b=d.length;a<b;a++){if(d[a]===c){return a}}return -1}function grep(b,f,a){var c=[];for(var d=0,e=b.length;d<e;d++){if(!a!==!f(b[d],d)){c.push(b[d])}}return c}function map(a,f){var b=[],e;for(var c=0,d=a.length;c<d;c++){e=f(a[c],c);if(e!=null){b[b.length]=e}}return b.concat.apply([],b)}var objectExtend={option:function(c,d){var b=c,a=this;a.options=a.options||{};if(typeof c=="string"){if(d===undefined){return a.options[c]}b={};b[c]=d}extend(a.options,b);return a},bind:function(c,b){var a=this,d=a._events=a._events||{};if(isFunction(b)){d[c]=d[c]||[];d[c].push(b)}return this},trigger:function(f,c){var b=this,g=b._events=b._events||{},e=g[f];if(!e){return this}c=isArray(c)?c:makeArray(c);for(var d=0,a=e.length;d<a;d++){e[d].apply(this,c)}return this},unbind:function(e,d){var b=this,f=b._events=b._events||{};if(!f[e]){return this}if(isFunction(d)){var a=f[e];for(var c=a.length;c--;c){if(a[c]===d||a[c]===d._proxy){a.splice(c,1)}}}else{delete f[e]}return this},one:function(d,c){if(!isFunction(c)){return this}var a=this,b=c._proxy=fun._proxy||function(){a.unbind(d,b);return c.apply(this,arguments)};a.bind(d,b)}};function param(b){var d=[];if(typeof b=="object"){for(var c in b){d[d.length]=encodeURIComponent(c)+"="+encodeURIComponent(b[c])}return d.join("&").replace(r20,"+")}return b}var jsc=now(),rquery=/\?/,rts=/(\?|&)_=.*?(&|$)/,r20=/%20/g,ajaxSettings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},lastModified={},etag={};function handleError(b,d,a,c){if(b.error){b.error.call(b.context||window,d,a,c)}}function httpSuccess(b){try{return !b.status&&location.protocol==="file:"||(b.status>=200&&b.status<300)||b.status===304||b.status===1223||b.status===0}catch(a){}return false}function httpNotModified(d,b){var c=d.getResponseHeader("Last-Modified"),a=d.getResponseHeader("Etag");if(c){lastModified[b]=c}if(a){etag[b]=a}return d.status===304||d.status===0}function httpData(f,d,c){var b=f.getResponseHeader("content-type"),a=d==="xml"||!d&&b&&b.indexOf("xml")>=0,e=a?f.responseXML:f.responseText;if(a&&e.documentElement.nodeName==="parsererror"){throw"parsererror"}if(c&&c.dataFilter){e=c.dataFilter(e,d)}if(typeof e==="string"){if(d==="json"){if(typeof JSON==="object"&&JSON.parse){e=JSON.parse(e)}else{e=(new Function("return "+e))()}}}return e}function ajaxSetup(a){extend(ajaxSettings,a)}function ajax(o){o=extend(true,o,extend(true,{},ajaxSettings,o));var d,f,c=o.context||window,j=o.type.toUpperCase();if(o.data&&o.processData&&typeof o.data!=="string"){o.data=param(o.data)}if(o.cache===false&&j==="GET"){var i=now();var h=o.url.replace(rts,"$1_="+i+"$2");o.url=h+((h===o.url)?(rquery.test(o.url)?"&":"?")+"_="+i:"")}if(o.data&&j==="GET"){o.url+=(rquery.test(o.url)?"&":"?")+o.data}var b=false;var n=o.xhr();if(o.username){n.open(j,o.url,o.async,o.username,o.password)}else{n.open(j,o.url,o.async)}try{if(o.data){n.setRequestHeader("Content-Type",o.contentType)}if(o.ifModified){if(lastModified[o.url]){n.setRequestHeader("If-Modified-Since",lastModified[o.url])}if(etag[o.url]){n.setRequestHeader("If-None-Match",etag[o.url])}}n.setRequestHeader("X-Requested-With","XMLHttpRequest");n.setRequestHeader("Accept",o.dataType&&o.accepts[o.dataType]?o.accepts[o.dataType]+", */*":o.accepts._default)}catch(g){}if(o.beforeSend&&o.beforeSend.call(c,n,o)===false){n.abort();return false}var l=function(p){if(!n||n.readyState===0){if(k){clearInterval(k);k=null}}else{if(!b&&n&&(n.readyState===4||p==="timeout")){b=true;if(k){clearInterval(k);k=null}d=p==="timeout"?"timeout":!httpSuccess(n)?"error":o.ifModified&&httpNotModified(n,o.url)?"notmodified":"success";if(d==="success"){try{f=httpData(n,o.dataType,o)}catch(q){d="parsererror"}}if(d==="success"||d==="notmodified"){m()}else{handleError(o,n,d)}a();if(p){n.abort()}if(o.async){n=null}}}};if(o.async){var k=setInterval(l,13);if(o.timeout>0){setTimeout(function(){if(n&&!b){l("timeout")}},o.timeout)}}try{n.send(j==="POST"||j==="PUT"?o.data:null)}catch(g){handleError(o,n,null,g)}if(!o.async){l()}function m(){if(o.success){o.success.call(c,f,d)}}function a(){if(o.complete){o.complete.call(c,n,d)}}return n}function emptyFunction(){}function jsonp(i){i=extend({},i);var c=""+param(i.data),a=i.context||window,g="jsonp"+jsc++,e=document.getElementsByTagName("head")[0]||document.documentElement,f=document.createElement("script");c=(c?(c+"&"):"")+(i.jsonp||"callback")+"="+g;i.url+=(rquery.test(i.url)?"&":"?")+c;f.src=i.url;if(i.scriptCharset){f.charset=i.scriptCharset}var b=false;window[g]=function(j){i.success&&i.success.call(a,j,"success");h()};f.onload=f.onreadystatechange=function(){if(!b&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d("error");h()}};if(i.timeout>0){setTimeout(function(){if(!b){d("timeout");h();window[g]=emptyFunction}},i.timeout)}e.insertBefore(f,e.firstChild);return undefined;function h(){b=true;window[g]=undefined;try{delete window[g]}catch(j){}f.onload=f.onreadystatechange=null;if(e&&f.parentNode){e.removeChild(f)}}function d(j){i.error&&i.error.call(a,j)}}var JSON=(function(){var b={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function c(d){return b[d]||"\\u00"+Math.floor(d.charCodeAt()/16).toString(16)+(d.charCodeAt()%16).toString(16)}function a(j){switch(Object.prototype.toString.call(j)){case"[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,c)+'"';case"[object Array]":var e=[],d=j.length;for(var h=0;h<d;h++){e.push(a(j[h]))}return"["+e.join(",")+"]";case"[object Object]":var e=[];for(var g in j){var f=a(j[g]);if(f){e.push(a(g)+":"+f)}}return"{"+e+"}";case"[object Number]":case"[object Boolean]":return String(j);case false:return"null"}return null}return{encode:a,decode:function(d){if(!d||!d.length){return null}return(new Function("return "+d))()}}})();function comet(c,b){var a=this;a._setting();a.options={jsonp:false,host:null,port:null,server:null,ticket:null,domain:null,url:{send:null}};extend(a.options,b)}extend(comet.prototype,objectExtend,{_setting:function(){var a=this;a.connected=false;a._connecting=false;a._onPolling=false;a._pollTimer=null;a._pollingTimes=0;a._failTimes=0},connect:function(c){var a=this;extend(a.options,c);if(a._connecting){return a}a._connecting=true;var c=a.options,b=false,d=[];each(["server","ticket","domain"],function(f,e){if(!c[e]){d.push(e);d.push(" required.");b=true}});if(b){a._onError("error",d.join(" "));return a}if(!a._onPolling){window.setTimeout(function(){a._startPolling()},300)}return a},close:function(){var a=this;if(a._pollTimer){clearTimeout(a._pollTimer)}a._setting();return a},_onConnect:function(){var a=this;a.connected=true;a.trigger("connect","success")},_onClose:function(a){var b=this;b._setting();b.trigger("close",[a])},_onData:function(b){var a=this;a.trigger("data",b)},_onError:function(b){var a=this;a._setting();a.trigger("error",b)},_startPolling:function(){var a=this,c=a.options;a._onPolling=true;a._pollingTimes++;var b=c.server+"/packets";var d={domain:c.domain,ticket:c.ticket};var e={url:b,data:d,timeout:40000,cache:false,context:a,success:a._onPollSuccess,error:a._onPollError};if(c.jsonp){extend(e,{timeout:40000,dataType:"jsonp",jsonp:"callback"});jsonp(e)}else{ajax(e)}},_onPollSuccess:function(b){var a=this;a._onPolling=false;if(!a._connecting){return}if(a._pollingTimes==1){a._onConnect()}a._onData(b);a._failTimes=0;a._pollTimer=window.setTimeout(function(){a._startPolling()},200)},_onPollError:function(a){var b=this;b._onPolling=false;if(!b._connecting){return}b._failTimes++;if(b._pollingTimes==1){b._onError("can not connect.")}else{if(b._failTimes>1){b._onClose(a)}else{b._pollTimer=window.setTimeout(function(){b._startPolling()},200)}}}});function cookie(b,j,m){if(typeof j!="undefined"){m=m||{};if(j===null){j="";m=extend({},m);m.expires=-1}var e="";if(m.expires&&(typeof m.expires=="number"||m.expires.toUTCString)){var f;if(typeof m.expires=="number"){f=new Date();f.setTime(f.getTime()+(m.expires*24*60*60*1000))}else{f=m.expires}e="; expires="+f.toUTCString()}var l=m.path?"; path="+(m.path):"";var g=m.domain?"; domain="+(m.domain):"";var a=m.secure?"; secure":"";document.cookie=[b,"=",encodeURIComponent(j),e,l,g,a].join("")}else{var d=null;if(document.cookie&&document.cookie!=""){var k=document.cookie.split(";");for(var h=0;h<k.length;h++){var c=trim(k[h]);if(c.substring(0,b.length+1)==(b+"=")){d=decodeURIComponent(c.substring(b.length+1));break}}}return d}}function webim(c,b){var a=this;a.options=extend({},webim.defaults,b);this._init(c,b)}extend(webim.prototype,objectExtend,{_init:function(){var a=this;a.data={user:{}};a.status=new webim.status();a.setting=new webim.setting();a.buddy=new webim.buddy();a.room=new webim.room();a.history=new webim.history();a.connection=new comet(null,{jsonp:true});a._initEvents()},ready:function(){var a=this;a._unloadFun=window.onbeforeunload;window.onbeforeunload=function(){};a.trigger("ready")},go:function(){var c=this,f=c.data,h=c.history,d=c.buddy,g=c.room;c.connection.connect(f.connection);h.option("userInfo",f.user);h.init(f.histories);d.handle(f.buddies);d.online(f.buddy_online_ids,true);var a=c.setting.get("block_list"),e=f.rooms;isArray(a)&&e&&each(a,function(j,b){e[b]&&(e[b].blocked=true)});g.handle(e);g.options.ticket=f.connection.ticket;var i=f.new_messages;if(i&&i.length){c.trigger("message",[i])}c.trigger("go",[f])},stop:function(b){var a=this;window.onbeforeunload=a._unloadFun;a.data.user.presence="offline";a.buddy.clear();a.trigger("stop",b)},autoOnline:function(){return !this.status.get("o")},_initEvents:function(){var c=this,a=c.status,d=c.setting,e=c.history,b=c.connection;b.bind("connect",function(g,f){}).bind("data",function(f){c.handle(f)}).bind("error",function(f){c.stop("connect error")}).bind("close",function(f){c.stop("disconnect")})},handle:function(b){var a=this;b.messages&&b.messages.length&&a.trigger("message",[b.messages]);b.presences&&b.presences.length&&a.trigger("presence",[b.presences]);b.statuses&&b.statuses.length&&a.trigger("status",[b.statuses])},sendMsg:function(b){var a=this;b.ticket=a.data.connection.ticket;ajax({type:"post",url:a.options.urls.message,type:"post",cache:false,data:b})},sendStatus:function(b){var a=this;b.ticket=a.data.connection.ticket;ajax({type:"post",url:a.options.urls.status,type:"post",cache:false,data:b})},setStranger:function(a){this.stranger_ids=idsArray(a)},stranger_ids:[],online:function(){var b=this,a=b.status,c=[],d=a.get("tabs"),e=a.get("tabIds");a.set("o",false);b.ready();e&&e.length&&d&&each(d,function(g,f){f.t=="buddy"&&c.push(g)});ajax({type:"post",dataType:"json",data:{buddy_ids:c.join(","),stranger_ids:b.stranger_ids.join(","),room_ids:getTid(b.roomIdendify),timestamp:parseInt(new Date().getTime()/1000)},url:b.options.urls.online,success:function(f){if(!f||!f.user||!f.connection){b.stop("online error")}else{f.user=extend(b.data.user,f.user);b.data=f;b.go()}},error:function(f){b.stop("online error")}})},offline:function(){var a=this,b=a.data;a.status.set("o",true);a.connection.close();a.stop("offline");ajax({type:"post",url:a.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:b.connection.ticket}})},refresh:function(){var a=this,b=a.data;if(!b||!b.connection||!b.connection.ticket){return}ajax({type:"post",url:a.options.urls.refresh,type:"post",cache:false,data:{ticket:b.connection.ticket}})}});function idsArray(a){return a&&a.split?a.split(","):(isArray(a)?a:(parseInt(a)?[parseInt(a)]:[]))}function model(b,d,c){function a(g,f){var e=this;e.data=g;e.options=extend({},a.defaults,f);isFunction(e._init)&&e._init()}a.defaults=d;extend(a.prototype,objectExtend,c);webim[b]=a}window.webim=webim;extend(webim,{version:"1.0.0pre",defaults:{},idsArray:idsArray,now:now,isFunction:isFunction,isArray:isArray,isObject:isObject,trim:trim,makeArray:makeArray,extend:extend,each:each,inArray:inArray,grep:grep,map:map,JSON:JSON,ajax:ajax,model:model,objectExtend:objectExtend});model("setting",{url:"/webim/setting",data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){var a=this;a.data=extend({},a.options.data,a.data)},get:function(a){return this.data[a]},set:function(e,g){var c=this,d=e;if(!e){return}if(typeof e=="string"){d={};d[e]=g}var b=c.data,a=checkUpdate(b,d);if(a){each(a,function(h,i){c.trigger("update",[h,i])});var f=extend({},b,d);c.data=f;ajax({type:"post",url:c.options.url,dataType:"json",cache:false,data:{data:JSON.encode(f)}})}}});model("status",{key:"_webim"},{_init:function(){var a=this,b=a.data;if(!b){var d=cookie(a.options.key);a.data=d?JSON.decode(d):{}}else{a._save(b)}},set:function(d,f){var c=d,b=this;if(typeof d=="string"){c={};c[d]=f}var a=b.data;if(checkUpdate(a,c)){var e=extend({},a,c);b._save(e)}},get:function(a){return this.data[a]},clear:function(){this._save({})},_save:function(a){this.data=a;cookie(this.options.key,JSON.encode(a),{path:"/",domain:document.domain})}});model("buddy",{url:"/webim/buddy"},{_init:function(){var a=this;a.data=a.data||[];a.dataHash={};a._cacheData={};a.handle(a.data)},clear:function(){var a=this;a.data=[];a.dataHash={};a._cacheData={}},count:function(f){var e=extend({},this.dataHash,this._cacheData),d=0,c;for(var b in e){if(isObject(f)){c=true;for(var a in f){if(f[a]!=e[b][a]){c=false}}if(c){d++}}else{d++}}return d},get:function(a){return this.dataHash[a]},online:function(b,a){this.changeStatus(b,"online",true,a)},offline:function(a){this.changeStatus(a,"offline",false)},loadDelay:function(){var b=this,a=b._cacheData,c=[];for(var d in a){c.push(d)}b.load(c)},update:function(a){this.load(a)},changeStatus:function(a,k,h,d){a=idsArray(a);var e=a.length;if(e){var o=this,b=o._cacheData,g=o.dataHash,m=[],c,j=[],n;for(var f=0;f<e;f++){c=a[f];if(g[c]){m.push({id:c,presence:k})}else{n={id:c,presence:k};if(!b[c]||b[c].presence!=k){j.push(n)}if(h){b[c]=n}else{if(b[c]){delete b[c]}}}}o.handle(m);if(h&&!d){o.loadDelay()}else{if(j.length){if(h){o.trigger(k+"Delay",[j])}else{o.trigger(k,[j])}}}}},_loadSuccess:function(f){var c=this.self||this,b=c._cacheData,a=f.length,e,g;for(var d in f){e=f[d];g=e.id;if(b[g]){extend(e,b[g]);delete b[g]}}c.handle(f)},load:function(c){c=idsArray(c);if(c.length){var a=this,b=a.options;ajax({url:b.url,cache:false,dataType:"json",data:{ids:c.join(",")},context:a,success:a._loadSuccess})}},handle:function(b){var m=this,e=m.data,f=m.dataHash,c={};b=b||[];var a=b.length,j,g,k;for(var d in b){j=b[d],id=j.id;if(id){if(!f[id]){f[id]={};e.push(f[id])}k=checkUpdate(f[id],j);if(k){g=k.presence||"update";c[g]=c[g]||[];extend(f[id],k);c[g].push(f[id])}}}for(var h in c){m.trigger(h,[c[h]])}}});(function(){model("room",{urls:{join:"/webim/join.php",leave:"/webim/leave.php",member:"/webim/members.php"}},{_init:function(){var a=this;a.data=a.data||[];a.dataHash={}},get:function(a){return this.dataHash[a]},block:function(e){var a=this,c=a.dataHash[e];if(c&&!c.blocked){c.blocked=true;var b=[];each(a.dataHash,function(f,d){if(d.blocked){b.push(d.id)}});a.trigger("block",[e,b])}},unblock:function(e){var a=this,c=a.dataHash[e];if(c&&c.blocked){c.blocked=false;var b=[];each(a.dataHash,function(f,d){if(d.blocked){b.push(d.id)}});a.trigger("unblock",[e,b])}},handle:function(f){var b=this,e=b.data,c=b.dataHash,a={};each(f,function(g,d){var h=d.id;if(h){d.members=d.members||[];d.count=d.count||0;d.all_count=d.all_count||0;if(!c[h]){c[h]=d;e.push(d)}else{extend(c[h],d)}b.trigger("join",[c[h]])}})},addMember:function(d,f){var b=this;if(isArray(f)){each(f,function(i,h){b.addMember(d,h)});return}var e=b.dataHash[d];if(e){var a=e.members,g;for(var c=a.length;c--;c){if(a[c].id==f.id){g=a[c]}}if(!g){f.name=f.nick||f.name;a.push(f);e.members.length;b.trigger("addMember",[d,f])}}},removeMember:function(d,c){var e=this.dataHash[d];if(e){var a=e.members,f;for(var b=a.length;b--;b){if(a[b].id==c){f=a[b];a.splice(b,1);e.count--}}f&&self.trigger("removeMember",[d,f])}},initMember:function(b){var a=this.dataHash[b];if(a&&!a.initMember){a.initMember=true;this.loadMember(b)}},loadMember:function(c){var a=this,b=a.options;ajax({cache:false,url:b.urls.member,dataType:"json",data:{ticket:b.ticket,id:c},success:function(d){each(d,function(f,e){a.addMember(f,e)})}})},join:function(d,b){var a=this,c=a.options;ajax({cache:false,url:c.urls.join,dataType:"json",data:{ticket:c.ticket,id:d,nick:b.name},success:function(e){a.initMember(d);a.handle([e])}})},leave:function(f,b){var a=this,c=a.options,e=a.dataHash[f];if(e){e.initMember=false;ajax({cache:false,url:c.urls.leave,data:{ticket:c.ticket,id:f,nick:b.name}});a.trigger("leave",[e])}},clear:function(){}})})();model("history",{urls:{load:"",clear:""}},{_init:function(){this.data=this.data||{}},get:function(a){return this.data[a]},handle:function(e){var m=this,g=m.data,b={};e=makeArray(e);var d=e.length,k,c,h=m.options.userInfo.id;if(!d){return}for(var f=0;f<d;f++){k=e[f];c=k.to==h?k.from:k.to;if(c!=undefined){b[c]=b[c]||[];b[c].push(k)}}var a=[];for(var j in b){var k=b[j];if(g[j]){g[j]=g[j].concat(k);m._triggerMsg(j,k)}else{a.push(j)}}m.load(a)},_triggerMsg:function(b,a){this.trigger("data",[b,a])},clear:function(e){e=idsArray(e);var b=this,a=e.length,c=b.options,f;if(a){for(var d=0;d<a;d++){f=e[d];b.data[f]=[];b.trigger("clear",[f])}ajax({url:c.urls.clear,cache:false,dataType:"json",data:{ids:e.join(",")}})}},init:function(d){var b=this.self||this,a;for(var c in d){a=d[c];b.data[c]=a;b._triggerMsg(c,a)}},load:function(d){d=idsArray(d);if(d.length){var a=this,b=a.options;for(var c=0;c<d.length;c++){a.data[d[c]]=[]}ajax({url:b.urls.load,cache:false,dataType:"json",data:{ids:d.join(",")},context:a,success:a.init})}}});model("hotpost",{url:"webim/hotpost"},{grep:function(a,b){return a&&a.text},handle:function(b){var a=this;b=grep(makeArray(b),a.grep);if(b.length){a.trigger("data",[b])}},load:function(){var a=this,b=a.options;ajax({url:b.url,cache:false,dataType:"json",context:a,success:a.handle})}});